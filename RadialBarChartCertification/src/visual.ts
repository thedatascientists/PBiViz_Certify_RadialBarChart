/*
*  Power BI Visual CLI
*
*  Copyright (c) Microsoft Corporation
*  All rights reserved.
*  MIT License
*
*  Permission is hereby granted, free of charge, to any person obtaining a copy
*  of this software and associated documentation files (the ""Software""), to deal
*  in the Software without restriction, including without limitation the rights
*  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
*  copies of the Software, and to permit persons to whom the Software is
*  furnished to do so, subject to the following conditions:
*
*  The above copyright notice and this permission notice shall be included in
*  all copies or substantial portions of the Software.
*
*  THE SOFTWARE IS PROVIDED *AS IS*, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
*  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
*  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
*  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
*  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
*  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
*  THE SOFTWARE.
*/
"use strict";

import "core-js/stable";
import "./../style/visual.less";
import powerbi from "powerbi-visuals-api";

import VisualConstructorOptions = powerbi.extensibility.visual.VisualConstructorOptions;
import VisualUpdateOptions = powerbi.extensibility.visual.VisualUpdateOptions;
import VisualTooltipDataItem = powerbi.extensibility.VisualTooltipDataItem;
import IVisual = powerbi.extensibility.visual.IVisual;
import IVisualHost = powerbi.extensibility.visual.IVisualHost;
import ISelectionManager = powerbi.extensibility.ISelectionManager;
import IVisualEventService = powerbi.extensibility.IVisualEventService;

import * as d3 from "d3";
import { createTooltipServiceWrapper, TooltipEventArgs, ITooltipServiceWrapper } from "powerbi-visuals-utils-tooltiputils";
import * as dataViewObjects from "powerbi-visuals-utils-dataviewutils/lib/index";
import * as valueFormatter from "powerbi-visuals-utils-formattingutils";
import { textMeasurementService } from "powerbi-visuals-utils-formattingutils";
import { TextProperties } from "powerbi-visuals-utils-formattingutils/lib/src/interfaces";
import { VisualSettings } from './settings';




interface ViewModel {
    dataPoints: DataPoint[];
    maxValue: number;
    average: number;
    total: number;
};

interface DataPoint {
    accu: number;
    os: string;
    category: string;
    value: number;
    valueSecondMeasure?: number;
    target?: number;
    extraValue: number;
    color?: string;
    format?: valueFormatter.valueFormatter.IValueFormatter;
    identity: powerbi.visuals.ISelectionId;
    tooltips: VisualTooltipDataItem[];
    displayNameCat?: string;
};

interface TotalInfo {
    group: string;
    groupTotal: number;
    active: boolean;
    identity?: powerbi.visuals.ISelectionId;
};

interface datum {
    startAngle?: number;
    endAngle?: number;
    outerRadius?: number;
    identity: powerbi.visuals.ISelectionId;
}

export class Visual implements IVisual {

    //We set up the basic elements that we will need. host page > svg > group
    private host: IVisualHost;
    // private svg: d3.Selection<SVGElement>;
    private svg: d3.Selection<SVGElement, unknown, HTMLElement, unknown>;
    private barGroup: d3.Selection<SVGElement, unknown, HTMLElement, unknown>;

    // Elements for the Arcs
    private circle: d3.Selection<SVGElement, unknown, HTMLElement, unknown>;
    private background: d3.Selection<SVGElement, unknown, HTMLElement, unknown>;

    private legend: d3.Selection<SVGElement, unknown, HTMLElement, unknown>;

    // private barGroup: d3.Selection<SVGElement>;
    private selectionManager: ISelectionManager;

    private events: IVisualEventService;

    private viewModel: ViewModel;

    private categorySelected: boolean;
    private identitySelected: object;
    private selectedCategoryName: string;
    private selectedCategoryColor: string;
    private last_step: string;
    private filteredCategories: Array<string>
    private totalByCategory: Array<TotalInfo>
    private cubeFormat: valueFormatter.valueFormatter.IValueFormatter;
    private cubeFormatIsPercentage: boolean;
    private detailCategorySelected: boolean;

    private tooltipServiceWrapper: ITooltipServiceWrapper;

    private spanElement;
    private svgTextElement;
    private canvasCty;
    private fallbackFontFamily;
    private extraTooltip;
    private existsSecondMeasure;
    private showSecondMeasureSettings;
    private existTargetMetric;
    private valueColumnName = "";

    private visualSettings: VisualSettings;

    private iValueFormatter = valueFormatter;


    defaultCubeFormat: string;
    targetValue: number;
    sortByValues: boolean;
    sortOrder: powerbi.SortDirection;
    elementOptions: HTMLElement;

    private target: HTMLElement;


    // Construct the basic elements
    constructor(options: VisualConstructorOptions) {

        this.host = options.host;  

        this.svg = d3.select(options.element)
            .append("svg")
            .classed("my-little-bar-chart", true)
            

        this.barGroup = this.svg.append("g")
            .classed("bar-group", true);

        this.selectionManager = this.host.createSelectionManager();

        this.background = this.svg
            .append("g")
            .classed("background", true)
        

        this.circle = this.svg
            .append("g")
            .classed("circle", true);

        this.legend = this.svg.append("g").classed("legend", true);

        this.tooltipServiceWrapper = createTooltipServiceWrapper(this.host.tooltipService, options.element);

        this.categorySelected = false; // variable to know if there is a category that is selected

        this.last_step = "first" // variable to know in which level we are

        this.filteredCategories = []

        this.extraTooltip = null;

        this.cubeFormatIsPercentage = false;

        this.elementOptions = options.element;

        this.events = options.host.eventService;

        this.target = options.element;

    }

    
    private renderLandingPage(options: VisualUpdateOptions) {

        // Create main container div for the landing page
        const landingPage = document.createElement('div');
        landingPage.classList.add('landing-page');
        landingPage.style.width = '100vw';  // Full viewport width
        landingPage.style.height = '100vh';  // Full viewport height
        landingPage.style.display = 'flex';
        landingPage.style.flexDirection = 'column';
        landingPage.style.justifyContent = 'center';
        landingPage.style.alignItems = 'center';
        landingPage.style.boxSizing = 'border-box';

        if (!options.dataViews || options.dataViews.length === 0 || !options.dataViews[0].categorical) {

            const existingLandingPage = this.target.querySelector('.landing-page');
            if (existingLandingPage) {
                this.target.removeChild(existingLandingPage);
            }
        

        
            // Header Section
            const header = document.createElement('div');
            header.classList.add('header');
            landingPage.appendChild(header); // Add header to landing page
        
            // Create the logo image
            const logo = document.createElement('img');
            logo.src = "data:image/png;base64, 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"; // Replace with your base64 string
            logo.alt = 'Company Logo';
            logo.style.width = '150px';  // Adjust size as necessary
            logo.style.marginBottom = '20px';  // Optional: space below logo
            header.appendChild(logo);
    
            // Header Title
            const headerTitle = document.createElement('h2');
            const titleSpan1 = document.createElement('span');
            titleSpan1.style.color = '#10155C';
            titleSpan1.textContent = 'Dynamic Radial Bar Chart';
            const titleSpan2 = document.createElement('span');
            titleSpan2.style.color = '#A8337D';
            titleSpan2.textContent = ' by JTA';
            headerTitle.appendChild(titleSpan1);
            headerTitle.appendChild(titleSpan2);
            headerTitle.style.color = '#333333';  // Set color for title
            header.appendChild(headerTitle);
    
            // Subtitle
            const headerSubtitle = document.createElement('h3');
            headerSubtitle.textContent = 'Interactive drilldown radial bar chart with multiple configurations';
            headerSubtitle.style.color = '#333333';  // Set color for subtitle
            header.appendChild(headerSubtitle);
    
            landingPage.appendChild(header);
    
            // Description Section
            const description = document.createElement('p');
            description.classList.add('description');
            description.textContent = 'This custom visual combines the functionality of a bar chart with the aesthetics of a radial chart. It displays multiple categories in a stacked and degradative layout, offering a visually appealing way to present hierarchical or comparative data.';
            description.style.color = '#333333';  // Set color for description
            landingPage.appendChild(description);
    
            // Screenshot Section
            const screenshotSection = document.createElement('div');
            screenshotSection.classList.add('screenshot-section');
            const screenshot = document.createElement('img');
            screenshot.src = 'data:image/png;base64,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'; // Replace with your screenshot Base64 string
            screenshot.alt = 'Screenshot of the Visual';
            screenshot.style.width = '100px';  // Adjust size as necessary
            screenshot.style.marginTop = '3px';  // Optional: space above screenshot
            screenshot.style.marginBottom = '3px';
            screenshotSection.appendChild(screenshot);
        
            landingPage.appendChild(screenshotSection);
        
            // Carousel Section
            const carousel = document.createElement('div');
            carousel.classList.add('carousel');
            carousel.style.marginTop = '0';
            const imageSlider = document.createElement('div');
            imageSlider.classList.add('image-slider');
            carousel.appendChild(imageSlider);
            landingPage.appendChild(carousel);
        
            // Footer Section with links
            const footer = document.createElement('div');
            footer.classList.add('footer');
            const footerList = document.createElement('ul');
        
            const footerLinks = [
                { name: 'Website', link: 'www.thedatascientists.com' },
                { name: 'LinkedIn', link: 'thedatascientists' },
                { name: 'YouTube', link: 'JTA The Data Scientists' },
                { name: 'Instagram', link: '@lifeatjta' },
                { name: 'TikTok', link: '@lifeatjta' }
            ];
        
            footerLinks.forEach(({ name, link }) => {
                const listItem = document.createElement('li');
        
                // Create a span or strong element for bold name
                const nameElement = document.createElement('strong');
                nameElement.textContent = name; // Add the name to the bold element
                listItem.appendChild(nameElement);
        
                // Add the link after the name
                const linkText = document.createTextNode(`: ${link}`);
                listItem.appendChild(linkText);
        
                footerList.appendChild(listItem);
            });
        
            footer.appendChild(footerList);
            landingPage.appendChild(footer);
        
            // Support Message Section
            const supportMessage = document.createElement('p');
            supportMessage.classList.add('support-message');
            const supportText = document.createElement('b');
            supportText.textContent = 'enquiries@thedatascientists.com';
            supportMessage.textContent = 'For any Questions, please reach out to ';
            supportMessage.appendChild(supportText);
            landingPage.appendChild(supportMessage);
        
            // Append the landing page content to the target element
            this.target.appendChild(landingPage);
        }

        

    }
    



    public update(options: VisualUpdateOptions) {

        this.events.renderingStarted(options);

        if (!options.dataViews || options.dataViews.length === 0 || !options.dataViews[0].categorical) {
            this.renderLandingPage(options)
        }
        else {
            const existingChart = this.target.querySelector('svg.my-little-bar-chart');
            if (existingChart) {
                this.visualSettings = VisualSettings.parse<VisualSettings>(options.dataViews[0]);

                const vL = valueFormatter.valueFormatter;
        
                // get data
                this.viewModel = this.getViewModel(options); 
                const viewModel = this.viewModel;
        
        
                // get size of the canvas
                let width = options.viewport.width;
                let height = options.viewport.height;
        
                this.svg.attr("fill", "transparent")
                
        
                // creates vertical sidebar
                if (height < 240) {
                    height = 240
                    this.elementOptions.style.overflowY = 'auto'
                    this.svg.attr("width", width)
                    this.svg.attr("height", height)
        
                } else{
                    this.elementOptions.style.overflowY = 'hidden'
                    this.svg.attr("width", width)
                    this.svg.attr("height", height)
                }
        
        
                // creates horizontal sidebar
                if (width < 290) {
                    width = 290
                    this.elementOptions.style.overflowX = 'auto'
                    this.svg.attr("width", width)
                    this.svg.attr("height", height)
                }else{
                    this.elementOptions.style.overflowX = 'hidden'
                    this.svg.attr("width", width)
                    this.svg.attr("height", height)
                }
                
        
                this.svg.selectAll("text").remove();
                this.svg.attr("width", width)
                    .attr("height", height)
        
                // Reset all the shapes to avoid artifacts in the update
                d3.selectAll("text").remove();
                d3.selectAll("path").remove();
                d3.selectAll("rect").remove();
                d3.selectAll("circle").remove();
                d3.selectAll("line").remove();
                d3.selectAll('svg > image').remove();
                this.legend.selectAll('.labelBackground').remove()
        
                const theradius = this.visualSettings.radialSettings.radius
        
                const arc = d3.arc()
                    .startAngle(0)
                    .cornerRadius(theradius)
        
                const arcShadow = d3.arc()
                    .startAngle(0)
                    .cornerRadius(0)
        
                const updatearc = (who, type, id) => {
                    const osnum = type[0];
                    const typenum = type[1];
                    const display = type[2];
        
                    
                    const limit = this.visualSettings.generalView.totalValueType == "fixed" 
                        ? this.visualSettings.generalView.fixedTotal 
                        : calculatedTotal;
        
        
            
                    d3.transition()
                        .select(id + osnum + "_" + typenum)
                        .transition()
                        .duration(id.includes("Shadow") ? 0 : this.visualSettings.animationSettings.enableAnimations 
                            ? osnum * (this.visualSettings.animationSettings.duration * 1000) 
                            : 0)
                        .call(arcTween, [type[2] * 1.5 * Math.PI / limit, id == "#monthArcShadow_" ? arcShadow : arc, osnum, typenum, display])
                        .on("end", () => {
                            this.events.renderingFinished(options);
                        });
        
                };
        
                const handleMouseClick = () => {
                    this.categorySelected = this.categorySelected == false ? true : false
                    this.filteredCategories = []
                    this.update(options);
                }
        
        
                let uniqueGroup = viewModel.dataPoints.filter(d => d != null).map(d => d.os).filter(this.onlyUnique)
        
                if(this.sortByValues){
                    const sortCategory = []
                    try {
                        for(let i = 0; i < uniqueGroup.length; i++){
                            sortCategory.push({
                                group: uniqueGroup[i],
                                groupTotal: <number>viewModel.dataPoints.filter(d => d != null).filter(d => d.os == uniqueGroup[i]).map(d => d.value).reduce((a, b) => a + b, 0)
                            })
                        }
                    } catch (error) {
                        console.log(error)
                    } 
        
                    sortCategory.sort(function(a, b){ return a.groupTotal < b.groupTotal ? -1 : 1 })
                    uniqueGroup = this.sortOrder == 1 ? Array.from(sortCategory, x => x.group).reverse() : Array.from(sortCategory, x => x.group) 
                }
                
                const line_tickness = (Math.min(width, height) / 2 - 20) / uniqueGroup.length
        
                this.totalByCategory = []
                let biggest = 0
                let maxGroup = null
        
                for (let index = 0; index < uniqueGroup.length; index++) {
        
                    const indexOnDataview = viewModel.dataPoints.indexOf(viewModel.dataPoints.filter(d => d.os == uniqueGroup[index])[0])
                    const currentSum = viewModel.dataPoints.filter(d => d != null).filter(d => d.os == uniqueGroup[index]).map(d => d.value).reduce((a, b) => a + b, 0)
                    
                    if(currentSum > biggest){
                        maxGroup =  uniqueGroup[index]
                        biggest = currentSum
                    }
                    this.totalByCategory.push({
                        group: uniqueGroup[index],
                        groupTotal: currentSum,
                        active: options.dataViews.map(d => d.categorical)[0].categories[0].objects != undefined ? dataViewObjects.dataViewObjects.getValue(options.dataViews.map(d => d.categorical)[0].categories[0].objects[indexOnDataview],
                            { objectName: "generalView", propertyName: "categoryToTotal" }, true) : true,
                        identity: viewModel.dataPoints.filter(d => d != null).filter(d => d.os == uniqueGroup[index])[0].identity
                    })
                }
        
                this.totalByCategory.push({
                    group: "total",
                    groupTotal: this.viewModel.dataPoints.map(d => d.value).reduce((a, b) => a + b, 0),
                    active: true,
                    identity: null
                })
        
                
                const total_active_categories = this.totalByCategory.filter(d => d.group != "total").filter(d => d.active).length
                const calculatedTotal = !this.categorySelected && total_active_categories != 0 && this.visualSettings.generalView.totalValueType == "sum" ? 
                                            this.totalByCategory.filter(d => d.group != "total").filter(d => d.active).map(d => d.groupTotal).reduce((a, b) => a + b, 0) : 
                                            this.visualSettings.generalView.totalValueType == "fixed" ? this.visualSettings.generalView.fixedTotal : this.totalByCategory.filter(d => d.group == maxGroup)[0].groupTotal
        
                const labels = []
                const percentageFormat = vL.create({ format: "0.0%" })
        
                for (let i = 0; i < 7; i++) {
                     
                    const limit = this.visualSettings.generalView.totalValueType == "fixed" ? this.visualSettings.generalView.fixedTotal : calculatedTotal
                    const quarter = Math.round(limit * (0.1666666 * i))
                    let value = ""
        
        
                    value = this.formatValue(quarter, this.defaultCubeFormat, this.visualSettings.numberLabels.decimalPlaces, this.visualSettings.numberLabels.quarterUnits)
                    labels.push(value)
                }
        
                
        
                let biggest_number = 0
                for (let i = 0; i < uniqueGroup.length; i++) {
                    const number = this.visualSettings.labelValueFormatting.showPercentages == "percentage" ? viewModel.dataPoints.filter(e => e.os == uniqueGroup[i]).map(e => e.value).reduce((a, b) => a + b, 0) / viewModel.total : viewModel.dataPoints.filter(e => e.os == uniqueGroup[i]).map(e => e.value).reduce((a, b) => a + b, 0)
        
                    biggest_number = biggest_number < number ? number : biggest_number
                }
        
                const wstart = width / 2
                const hstart = (height / 2)
                const radial_height = (Math.min(width, height) / 2 - 20) / uniqueGroup.length
        
        
                if (this.visualSettings.labelFormatting.showLabels) {
                    try {
                        // The following text corresponds to the text of the labels of each bar
                        //In this case they appear outside so they are on the top left quarter
        
                        this.circle.selectAll(".labelText")
                            .data(uniqueGroup)
                            .enter()
                            .append("text")
                            .attr("class", "labelText")
                            .attr('x', (d) => {
                                const formattedValue = this.visualSettings.labelValueFormatting.showPercentages == "percentage" ? percentageFormat.format(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0) / calculatedTotal) : 
                                                        this.formatValue(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0), this.defaultCubeFormat, this.visualSettings.labelValueFormatting.decimalPlaces, this.visualSettings.labelValueFormatting.displayUnits)
        
        
        
                                const separatorLabel = !this.visualSettings.labelValueFormatting.showLabels && !this.visualSettings.labelFormatting.showLabels ? "" : "\u00A0|\u00A0"
                                const valueLabelWidth = this.measureWordWidth(formattedValue, this.visualSettings.labelValueFormatting.size, this.visualSettings.labelValueFormatting.fontFamily, this.visualSettings.labelValueFormatting.textWeight, this.visualSettings.labelValueFormatting.fontItalic)
                                const separatorLabelWidth = this.measureWordWidth(separatorLabel, this.visualSettings.labelSeparator.size, this.visualSettings.labelSeparator.fontFamily, this.visualSettings.labelSeparator.textWeight, this.visualSettings.labelSeparator.fontItalic);
        
        
        
                                if(this.visualSettings.labelValueFormatting.showLabels) {
        
                                    if( this.visualSettings.labelFormatting.labelAlignment == "right") {
                                        return wstart
                                    } else if( this.visualSettings.labelFormatting.labelAlignment == "left") {
                                        return wstart - radial_height * uniqueGroup.length * 0.95 + valueLabelWidth + separatorLabelWidth
                                    }
                                    else if( this.visualSettings.labelFormatting.labelAlignment == "center") {
                                        return wstart - radial_height * uniqueGroup.length * 0.5 + separatorLabelWidth / 2
                                    }
        
                                } else return this.visualSettings.labelFormatting.labelAlignment == "right" ? wstart : 
                                             (this.visualSettings.labelFormatting.labelAlignment == "left" ? wstart - radial_height * uniqueGroup.length * 0.95 : 
                                                this.visualSettings.labelFormatting.labelAlignment == "center" ? wstart - radial_height * uniqueGroup.length * 0.5 : 
                                             "") 
        
        
                            })
                            .attr('y', (d, i) => hstart - (radial_height * (i + 1)) + (radial_height * 0.55))
                            .attr("dx", -5)
                            .attr("id", (d, i) => "themark_" + i)
                            .attr("text-anchor", this.visualSettings.labelFormatting.labelAlignment == "center" ? (this.visualSettings.labelValueFormatting.showLabels ? "start" : "middle") : this.visualSettings.labelFormatting.labelAlignment == "left" ? "start" : "end")
                            .attr("font-size", this.visualSettings.labelFormatting.size + 'pt')
                            .attr("font-weight", this.visualSettings.labelFormatting.textWeight ? "bold" : "normal")
                            .attr("text-decoration", this.visualSettings.labelFormatting.fontUnderline ? "underline": "normal")
                            .attr("font-style", this.visualSettings.labelFormatting.fontItalic ? "italic": "normal")
                            .style("font-family", this.visualSettings.labelFormatting.fontFamily)
                            .style("fill", this.visualSettings.labelFormatting.fontColor)
                            .text( (d) => {
                                const formattedValue = this.visualSettings.labelValueFormatting.showPercentages == "percentage" ? percentageFormat.format(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0) / calculatedTotal) : 
                                                            this.formatValue(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0), this.defaultCubeFormat, this.visualSettings.labelValueFormatting.decimalPlaces, this.visualSettings.labelValueFormatting.displayUnits)
        
        
                            
                                const separatorLabel = !this.visualSettings.labelValueFormatting.showLabels && !this.visualSettings.labelFormatting.showLabels ? "" : "\u00A0|\u00A0"
                                const labelWidth = this.measureWordWidth(d, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
                                const valueLabelWidth = this.measureWordWidth(formattedValue, this.visualSettings.labelValueFormatting.size, this.visualSettings.labelValueFormatting.fontFamily, this.visualSettings.labelValueFormatting.textWeight, this.visualSettings.labelValueFormatting.fontItalic);
                                const separatorLabelWidth = this.measureWordWidth(separatorLabel, this.visualSettings.labelSeparator.size, this.visualSettings.labelSeparator.fontFamily, this.visualSettings.labelSeparator.textWeight, this.visualSettings.labelSeparator.fontItalic);
                            
                            
                                const completeLabelWidth = this.visualSettings.labelFormatting.showLabels && this.visualSettings.labelValueFormatting.showLabels ?
                                                                valueLabelWidth + separatorLabelWidth + labelWidth :
                                                            this.visualSettings.labelFormatting.showLabels && !this.visualSettings.labelValueFormatting.showLabels ?
                                                                labelWidth :
                                                            !this.visualSettings.labelFormatting.showLabels && this.visualSettings.labelValueFormatting.showLabels ? 
                                                                valueLabelWidth :
                                                                0;
                            
                                                                
                                const availableSpace = this.visualSettings.labelFormatting.labelAlignment == "right" || this.visualSettings.labelFormatting.labelAlignment == "left" ? radial_height * uniqueGroup.length * 0.95 : radial_height * uniqueGroup.length                              
                                
                                
                                const ellipsis = "...";
        
                                // Truncate text if it exceeds available space
                                if (completeLabelWidth > availableSpace) {
                                    let truncatedText = d;
                                    let currentWidth = this.measureWordWidth(truncatedText, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
                            
                                    while (currentWidth > availableSpace && truncatedText.length > 0) {
                                        truncatedText = truncatedText.slice(0, -1);  
                                        currentWidth = this.measureWordWidth(truncatedText.slice(0, -3) + ellipsis, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
                                    }
                            
                                    return truncatedText.slice(0, -3) + ellipsis; 
                                }
                            
                                return d;
                            })                    
                            .on("click", (d, i) => {
                                // when one category is clicked, the visual moves to another level with the detailed categories
                                if ((this.existsSecondMeasure && this.visualSettings.radialSettings.activateDrilldown) ||
                                    (!this.existsSecondMeasure && this.visualSettings.radialSettings.activateDrilldown)) {
                            
                                    if (!this.categorySelected) {
                                        // If there are no categories selected, the visual appears normal (not filtered)
                                        this.selectionManager.clear();
                                        const identity = viewModel.dataPoints.filter(d => d.os == <string><unknown>i).map(d => d.identity);
                                        return this.selectionManager.select(identity, true).then(() => {
                                            this.selectedCategoryName = <string><unknown>i;
                                            this.selectedCategoryColor = viewModel.dataPoints.filter(d => d.os == <string><unknown>i)[0].color;
                                            this.categorySelected = !this.categorySelected;
                                            this.last_step = "first";
                                            this.update(options);
                                        });
                            
                                    } else {
                                        // In case one category is selected, the visual is filtered by that category 
                                        const identity = this.viewModel.dataPoints.filter(d => d.category == i)[0].identity;
                            
                                        if (this.identitySelected === identity) { // Click a category that is already selected, reset to default state
                                            this.selectionManager.clear();
                                            this.detailCategorySelected = false;
                                            this.update(options);
                                        } else {
                                            this.identitySelected = identity;
                            
                                            // This allows us to track at which level we are
                                            if (this.last_step === "first") {
                                                this.last_step = "second";
                                                this.selectionManager.clear();
                                            }
                            
                                            if (!event["ctrlKey"]) {
                                                this.selectionManager.clear();
                                                this.filteredCategories = [];
                                            }
                            
                                            if (!this.visualSettings.iconHome.allowGoBack_label) {
                                                return this.selectionManager.select(identity, true).then((ids: powerbi.visuals.ISelectionId[]) => {
                                                    this.detailCategorySelected = true;
                                                    this.filteredCategories.push(viewModel.dataPoints.filter(d => d.category == i)[0].category);
                            
                                                    d3.selectAll(".circle_path").style("fill-opacity", 0.2);
                            
                                                    for (let i = 0; i < ids.length; i++) {
                                                        d3.select("#" + (event.target as HTMLElement).getAttribute("id")).style("fill-opacity", 1);
                                                        d3.selectAll("[identifier='" + viewModel.dataPoints.filter(d => d.identity == ids[i])[0].category + "']").style("fill-opacity", 1);
                                                    }
                                                });
                                            } else {
                                                this.selectionManager.clear();
                                                return handleMouseClick();
                                            }
                                        }
                                    }
                                } else {
                                    console.log("NO SECOND LEVEL");
                                }
                            });
                            
                    } catch (error) {
                        console.log(error)
                    }
                }
        
        
        
                if (this.visualSettings.labelValueFormatting.showLabels) {
                    try {
                        // The following text corresponds to the text of the labels of each bar
                        //In this case they appear outside so they are on the top left quarter
        
                        this.circle.selectAll(".labelValueText")
                            .data(uniqueGroup)
                            .enter()
                            .append("text")
                            .attr("class", "labelValueText")
                            .attr('x', (d) => {
                                const formattedValue = this.visualSettings.labelValueFormatting.showPercentages == "percentage" ? percentageFormat.format(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0) / calculatedTotal) : 
                                                        this.formatValue(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0), this.defaultCubeFormat, this.visualSettings.labelValueFormatting.decimalPlaces, this.visualSettings.labelValueFormatting.displayUnits)
        
        
                                const separatorLabel = !this.visualSettings.labelValueFormatting.showLabels && !this.visualSettings.labelFormatting.showLabels ? "" : "\u00A0|\u00A0"
                                let labelWidth = this.measureWordWidth(d, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic)
                                const valueLabelWidth = this.measureWordWidth(formattedValue, this.visualSettings.labelValueFormatting.size, this.visualSettings.labelValueFormatting.fontFamily, this.visualSettings.labelValueFormatting.textWeight, this.visualSettings.labelValueFormatting.fontItalic)
                                const separatorLabelWidth = this.measureWordWidth(separatorLabel, this.visualSettings.labelSeparator.size, this.visualSettings.labelSeparator.fontFamily, this.visualSettings.labelSeparator.textWeight, this.visualSettings.labelSeparator.fontItalic);
        
        
                                const completeLabelWidth = this.visualSettings.labelFormatting.showLabels && this.visualSettings.labelValueFormatting.showLabels ?
                                                                valueLabelWidth + separatorLabelWidth + labelWidth :
                                                            this.visualSettings.labelFormatting.showLabels && !this.visualSettings.labelValueFormatting.showLabels ?
                                                                labelWidth :
                                                            !this.visualSettings.labelFormatting.showLabels && this.visualSettings.labelValueFormatting.showLabels ? 
                                                                valueLabelWidth :
                                                                0;
        
                                                                
                                const availableSpace = this.visualSettings.labelFormatting.labelAlignment == "right" || this.visualSettings.labelFormatting.labelAlignment == "left" ? radial_height * uniqueGroup.length * 0.95 : radial_height * uniqueGroup.length                              
        
        
                                const ellipsis = "...";
               
                                // Truncate text if it exceeds available space
                                if (completeLabelWidth > availableSpace) {
                                    let truncatedText = d;
                                    let currentWidth = this.measureWordWidth(truncatedText, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
        
                                    while (currentWidth> availableSpace && truncatedText.length > 0) {
                                        truncatedText = truncatedText.slice(0, -1);  
                                        currentWidth = this.measureWordWidth(truncatedText.slice(0, -3) + ellipsis, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
                                    }
        
                                    labelWidth = this.measureWordWidth(truncatedText.slice(0, -3) + ellipsis, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
                                }
        
                                if(this.visualSettings.labelFormatting.showLabels) {
                                    if( this.visualSettings.labelFormatting.labelAlignment == "right") {
                                        return wstart - labelWidth - separatorLabelWidth
                                    } else if( this.visualSettings.labelFormatting.labelAlignment == "left") {
                                        return wstart - radial_height * uniqueGroup.length * 0.95
                                    } else if( this.visualSettings.labelFormatting.labelAlignment == "center") {
                                        return wstart - radial_height * uniqueGroup.length * 0.5 - separatorLabelWidth / 2
                                    }
                                } else return this.visualSettings.labelFormatting.labelAlignment == "right" ? wstart : 
                                              this.visualSettings.labelFormatting.labelAlignment == "left" ? wstart - radial_height * uniqueGroup.length * 0.95 :
                                              this.visualSettings.labelFormatting.labelAlignment == "center" ? wstart - radial_height * uniqueGroup.length * 0.5 : ""
         
                            })
                            .attr('y', function (d, i) {
                                return hstart - (radial_height * (i + 1)) + (radial_height * 0.55)
                            })
                            .attr("dx", -5)
                            .attr("id", (d, i) => "themark_" + i)
                            .attr("text-anchor", this.visualSettings.labelFormatting.labelAlignment == "center" ? (this.visualSettings.labelFormatting.showLabels ? "end" : "middle") : this.visualSettings.labelFormatting.labelAlignment == "left" ? "start" : "end")
                            .attr("font-size", this.visualSettings.labelValueFormatting.size + 'pt')
                            .attr("font-weight", this.visualSettings.labelValueFormatting.textWeight ? "bold" : "normal")
                            .attr("text-decoration", this.visualSettings.labelValueFormatting.fontUnderline ? "underline": "normal")
                            .attr("font-style", this.visualSettings.labelValueFormatting.fontItalic ? "italic": "normal")
                            .style("font-family", this.visualSettings.labelValueFormatting.fontFamily)
                            .style("fill", this.visualSettings.labelValueFormatting.fontColor)
                            .text((d) => {
        
                                const formattedValue =  this.visualSettings.labelValueFormatting.showPercentages == "percentage" ? percentageFormat.format(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0) / calculatedTotal) : 
                                                            this.formatValue(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0), this.defaultCubeFormat, this.visualSettings.labelValueFormatting.decimalPlaces, this.visualSettings.labelValueFormatting.displayUnits)
        
                                return formattedValue
                                
        
                            })
                            .on("click", (d, i) => {
        
                                // when one category is clicked, the visual moves to another level with the detailed categories
                                if((this.existsSecondMeasure && this.visualSettings.radialSettings.activateDrilldown) || (!this.existsSecondMeasure && this.visualSettings.radialSettings.activateDrilldown)){
                                    
                                    if (!this.categorySelected) {
        
                                        // if there are no category selected, the visual appears normal, i.e., not filtered
                                       
                                        this.selectionManager.clear()
                                        const identity = viewModel.dataPoints.filter(d => d.os == <string><unknown>i).map(d => d.identity)
        
                                        return this.selectionManager.select(identity, true).then(() => {
                                            this.selectedCategoryName = <string><unknown>i
                                            this.selectedCategoryColor = viewModel.dataPoints.filter(d => d.os == <string><unknown>i)[0].color
                                            this.categorySelected = this.categorySelected == false ? true : false
                                            this.last_step = "first"
                                            this.update(options);
                                        });
        
                                    } else {
        
                                        // In case one category is selected, the visual is filtered by that category 
        
                                        const identity = this.viewModel.dataPoints.filter(d => d.category == i)[0].identity
        
                                        if(this.identitySelected == identity){ // Click a category that is already selected, reset to default state
                                            this.selectionManager.clear()
                                            this.detailCategorySelected = false
                                            this.update(options);
                                        } else{
                                            this.identitySelected = identity
                                            
                                            // this allow us to know at which level are we in
                                            if (this.last_step == "first") {
                                                this.last_step = "second"
                                                this.selectionManager.clear()
                                            }
            
                                            if (!event["ctrlKey"]) {
                                                this.selectionManager.clear()
                                                this.filteredCategories = []
                                            }
        
            
                                            if(!this.visualSettings.iconHome.allowGoBack_label){
                                                return this.selectionManager.select(identity, true).then((ids: powerbi.visuals.ISelectionId[]) => {
        
                                                    this.detailCategorySelected = true
        
                                                    this.filteredCategories.push(viewModel.dataPoints.filter(d => d.category == i)[0].category)
                
                                                    d3.selectAll(".circle_path").style("fill-opacity", 0.2)
                
                
                                                    for (let i = 0; i < ids.length; i++) {
                
                                                        d3.select("#" + (event.target as HTMLElement).getAttribute("id")).style("fill-opacity", 1);
                                                        d3.selectAll("[identifier='" + viewModel.dataPoints.filter(d => d.identity == ids[i])[0].category + "']").style("fill-opacity", 1)
                                                    }
                
                                                });                                             
                                            }
                                            else {
                                                this.selectionManager.clear()
                                                return handleMouseClick();                                        
                                            }                               
                                        }
        
        
        
                                    }
                                } else{
                                    console.log("NO SECOND LEVEL")
                                }
        
                            })
                    } catch (error) {
                        console.log(error)
                    }
                }
        
        
                if (this.visualSettings.labelValueFormatting.showLabels && this.visualSettings.labelFormatting.showLabels) {
                    try {
                        // The following text corresponds to the text of the labels of each bar
                        //In this case they appear outside so they are on the top left quarter
        
                        this.circle.selectAll(".labelSeparatorText")
                            .data(uniqueGroup)
                            .enter()
                            .append("text")
                            .attr("class", "labelSeparatorText")
                            .attr('x', (d) => {
                                const formattedValue = this.visualSettings.labelValueFormatting.showPercentages == "percentage" ? percentageFormat.format(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0) / calculatedTotal) : 
                                                            this.formatValue(viewModel.dataPoints.filter(e => e.os == d).map(e => e.value).reduce((a, b) => a + b, 0), this.defaultCubeFormat, this.visualSettings.labelValueFormatting.decimalPlaces, this.visualSettings.labelValueFormatting.displayUnits)
        
        
                                const separatorLabel = !this.visualSettings.labelValueFormatting.showLabels && !this.visualSettings.labelFormatting.showLabels ? "" : "\u00A0|\u00A0"
                                let labelWidth = this.measureWordWidth(d, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
                                const valueLabelWidth = this.measureWordWidth(formattedValue, this.visualSettings.labelValueFormatting.size, this.visualSettings.labelValueFormatting.fontFamily, this.visualSettings.labelValueFormatting.textWeight, this.visualSettings.labelValueFormatting.fontItalic);
                                const separatorLabelWidth = this.measureWordWidth(separatorLabel, this.visualSettings.labelSeparator.size, this.visualSettings.labelSeparator.fontFamily, this.visualSettings.labelSeparator.textWeight, this.visualSettings.labelSeparator.fontItalic);
                            
                            
                                const completeLabelWidth = this.visualSettings.labelFormatting.showLabels && this.visualSettings.labelValueFormatting.showLabels ?
                                                                valueLabelWidth + separatorLabelWidth + labelWidth :
                                                            this.visualSettings.labelFormatting.showLabels && !this.visualSettings.labelValueFormatting.showLabels ?
                                                                labelWidth :
                                                            !this.visualSettings.labelFormatting.showLabels && this.visualSettings.labelValueFormatting.showLabels ? 
                                                                valueLabelWidth :
                                                                0;
                            
                                                                
                                const availableSpace = this.visualSettings.labelFormatting.labelAlignment == "right" || this.visualSettings.labelFormatting.labelAlignment == "left" ? radial_height * uniqueGroup.length * 0.95 : radial_height * uniqueGroup.length                              
                                
                                
                                const ellipsis = "...";
        
                                // Truncate text if it exceeds available space
                                if (completeLabelWidth > availableSpace) {
                                    let truncatedText = d;
                                    let currentWidth = this.measureWordWidth(truncatedText, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
                            
                                    while (currentWidth > availableSpace && truncatedText.length > 0) {
                                        truncatedText = truncatedText.slice(0, -1);  
                                        currentWidth = this.measureWordWidth(truncatedText.slice(0, -3) + ellipsis, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
                                    }
                            
                                    labelWidth = this.measureWordWidth(truncatedText.slice(0, -3) + ellipsis, this.visualSettings.labelFormatting.size, this.visualSettings.labelFormatting.fontFamily, this.visualSettings.labelFormatting.textWeight, this.visualSettings.labelFormatting.fontItalic);
                                }
        
        
                                if( this.visualSettings.labelFormatting.labelAlignment == "right") {
                                    return wstart - labelWidth
                                } else if( this.visualSettings.labelFormatting.labelAlignment == "left") {
                                    return wstart - radial_height * uniqueGroup.length * 0.95 + valueLabelWidth
                                }
                                else if( this.visualSettings.labelFormatting.labelAlignment == "center") {
                                    return wstart - radial_height * uniqueGroup.length * 0.5
                                }
        
        
                            })
                            .attr('y', function (d, i) {
                                return hstart - (radial_height * (i + 1)) + (radial_height * 0.55)
                            })
                            .attr("dx", -5)
                            .attr("id", (d, i) => "themark_" + i)
                            .attr("text-anchor", this.visualSettings.labelFormatting.labelAlignment == "center" ? "middle" : this.visualSettings.labelFormatting.labelAlignment == "left" ? "start" : "end")
                            .attr("font-size", this.visualSettings.labelSeparator.size + 'pt')
                            .attr("font-weight", this.visualSettings.labelSeparator.textWeight ? "bold" : "normal")
                            .attr("text-decoration", this.visualSettings.labelSeparator.fontUnderline ? "underline": "normal")
                            .attr("font-style", this.visualSettings.labelSeparator.fontItalic ? "italic": "normal")
                            .style("font-family", this.visualSettings.labelSeparator.fontFamily)
                            .style("fill", this.visualSettings.labelSeparator.fontColor)
                            .text("\u00A0|\u00A0")
                            .on("click", (d, i) => {
        
                                // when one category is clicked, the visual moves to another level with the detailed categories
                                if((this.existsSecondMeasure && this.visualSettings.radialSettings.activateDrilldown) || (!this.existsSecondMeasure && this.visualSettings.radialSettings.activateDrilldown)){
                                    
                                    if (!this.categorySelected) {
        
                                        // if there are no category selected, the visual appears normal, i.e., not filtered
                                       
                                        this.selectionManager.clear()
                                        const identity = viewModel.dataPoints.filter(d => d.os == <string><unknown>i).map(d => d.identity)
                                        return this.selectionManager.select(identity, true).then(() => {
                                            this.selectedCategoryName = <string><unknown>i
                                            this.selectedCategoryColor = viewModel.dataPoints.filter(d => d.os == <string><unknown>i)[0].color
                                            this.categorySelected = this.categorySelected == false ? true : false
                                            this.last_step = "first"
                                            this.update(options);
                                        });
        
                                    } else {
        
                                        // In case one category is selected, the visual is filtered by that category 
        
                                        const identity = this.viewModel.dataPoints.filter(d => d.category == i)[0].identity
        
                                        if(this.identitySelected == identity){ // Click a category that is already selected, reset to default state
                                            this.selectionManager.clear()
                                            this.detailCategorySelected = false
                                            this.update(options);
                                        } else{
                                            this.identitySelected = identity
                                            
                                            // this allow us to know at which level are we in
                                            if (this.last_step == "first") {
                                                this.last_step = "second"
                                                this.selectionManager.clear()
                                            }
            
                                            if (!event["ctrlKey"]) {
                                                this.selectionManager.clear()
                                                this.filteredCategories = []
                                            }
        
            
                                            if(!this.visualSettings.iconHome.allowGoBack_label){
                                                return this.selectionManager.select(identity, true).then((ids: powerbi.visuals.ISelectionId[]) => {
        
                                                    this.detailCategorySelected = true
        
                                                    this.filteredCategories.push(viewModel.dataPoints.filter(d => d.category == i)[0].category)
                
                                                    d3.selectAll(".circle_path").style("fill-opacity", 0.2)
                
                
                                                    for (let i = 0; i < ids.length; i++) {        
                                                        d3.select("#" + (event.target as HTMLElement).getAttribute("id")).style("fill-opacity", 1);
                                                        d3.selectAll("[identifier='" + viewModel.dataPoints.filter(d => d.identity == ids[i])[0].category + "']").style("fill-opacity", 1)
                                                    }
                
                                                });                                             
                                            }
                                            else {
                                                this.selectionManager.clear()
                                                return handleMouseClick();                                        
                                            }                               
                                        }
        
        
        
                                    }
                                } else{
                                    console.log("NO SECOND LEVEL")
                                }
        
                            })
                    } catch (error) {
                        console.log(error)
                    }
                }
        
        
        
                let color_index = this.visualSettings.radialSettings.startingOpacity/100
        
        
        
                for (let groupIndex = 0; groupIndex <= uniqueGroup.length - 1; groupIndex++) {
                    const dataview_category_values = this.existsSecondMeasure && this.categorySelected ? viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex]).map(d => d.valueSecondMeasure) : viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex]).map(d => d.accu)
                    const uniqueCategories = viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex]).map(d => d.category).filter(this.onlyUnique)
        
                    const is_category_over_limit = this.totalByCategory.filter(d => d.group == uniqueGroup[groupIndex])[0].groupTotal > calculatedTotal
                    const category_limit = is_category_over_limit ? calculatedTotal : this.totalByCategory.filter(d => d.group == uniqueGroup[groupIndex])[0].groupTotal
                    let calculated_category_values = []
                    if (is_category_over_limit) {
                        for (const value of dataview_category_values) {
                            calculated_category_values.push((value * category_limit) / this.totalByCategory.filter(d => d.group == uniqueGroup[groupIndex])[0].groupTotal)
                        }
                    } else {
                        calculated_category_values = dataview_category_values
                    }
        
                    d3.select("#demo10")
                        .append("g")
                        .attr("transform", "translate(500,500)");
                    
                    if (this.visualSettings.radialSettings.shadowVisible == "shadow") {
        
                        // creates background behind the radial bars
                        this.background.append("path")
                            .datum({ startAngle: 0, endAngle: 0.001, innerRadius: (0.1 * line_tickness) + (line_tickness * groupIndex), outerRadius: line_tickness * (groupIndex + 1), identity: viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex])[0].identity })
                            .attr('d', arcShadow)
                            .attr("class", "shadow_circle_path")
                            .style("fill", this.visualSettings.radialSettings.shadowColor)
                            .style("fill-opacity", this.visualSettings.radialSettings.shadowOpacity/100)
                            .attr("id", "monthArcShadow_" + groupIndex + "_" + groupIndex)
                            .attr('transform', 'translate(' + wstart + ',' + (hstart) + ')')                    
                            .style('stroke-linejoin', 'round')
                            .call(updatearc, [groupIndex, groupIndex, calculatedTotal, (calculatedTotal / category_limit)], "#monthArcShadow_")
                            
        
                    } else {
                        // creates sonar lines
                        this.background.append("path")
                            .attr("d", d3.arc()
                                .innerRadius((0.5 * line_tickness) + (line_tickness * groupIndex))
                                .outerRadius((0.55 * line_tickness) + (line_tickness * (groupIndex)))
                                .startAngle(-6.28)     // It's in radian, so Pi = 3.14 = bottom.
                                .endAngle(-1.57)       // 2*Pi = 6.28 = top
                            )
                            .attr('fill', this.visualSettings.referenceLine.sonarLinesColor)
                            .attr("transform", 'translate(' + wstart + ',' + (hstart) + ')')
                            .attr("fill-opacity", this.visualSettings.referenceLine.sonarOpacity/100)
        
                    }
        
        
        
        
                    if (this.visualSettings.referenceLine.showReferenceLines) {
                            
                        // creates last reference line
                        this.background.append("line")
                            .attr("x1", wstart)
                            .attr("y1", hstart)
                            .attr("x2", wstart - (line_tickness * (uniqueGroup.length) * 1.05))
                            .attr("y2", hstart)
                            .attr("stroke-opacity", this.visualSettings.referenceLine.sonarOpacity/100)
                            .attr("stroke-dasharray", this.visualSettings.referenceLine.dashline)
                            .attr("stroke", this.visualSettings.referenceLine.sonarLinesColor)
                            .attr("stroke-width", this.visualSettings.referenceLine.sonarLineWidth)
        
        
        
                        for (let i = -2; i < 4; i++) {
        
                            // creates reference lines
                            this.background.append("line")
                                .attr("id", "shadowLine" + i)
                                .attr("x1", wstart)
                                .attr("y1", hstart)
                                .attr("x2", calculateRadialPoints(i, 10)[0])
                                .attr("y2", calculateRadialPoints(i, 10)[1])
                                .attr("stroke-opacity", this.visualSettings.referenceLine.sonarOpacity/100)
                                .attr("stroke-dasharray", this.visualSettings.referenceLine.dashline)
                                .attr("stroke", this.visualSettings.referenceLine.sonarLinesColor)
                                .attr("stroke-width", this.visualSettings.referenceLine.sonarLineWidth)
                        }
                    }
        
                    
                    
                    color_index = !this.categorySelected ? this.visualSettings.radialSettings.startingOpacity/100 : color_index + this.visualSettings.radialSettings.opacitySteps/100
        
                    for (let category_index = calculated_category_values.length - 1; category_index >= 0; category_index--) {
        
                        
                        if (dataview_category_values[category_index] != 0.001) {
                            
                            // creates the radial bars
                            this.circle
                                .append("path")
                                .datum({ startAngle: 0, 
                                            endAngle: 0.001, 
                                            innerRadius: (0.1 * line_tickness) + (line_tickness * groupIndex), 
                                            outerRadius: line_tickness * (groupIndex + 1), 
                                            identity: this.viewModel.dataPoints.filter(d => d.category == uniqueCategories[category_index])[0].identity, 
                                            category: this.categorySelected ? uniqueCategories[category_index] : uniqueGroup[groupIndex], 
                                            group: this.viewModel.dataPoints.filter(d => d.category == uniqueCategories[category_index])[0].category,
                                            value: viewModel.dataPoints.filter(d => d.os == (this.categorySelected ? uniqueCategories[category_index] : 
                                            uniqueGroup[groupIndex])).filter(d => d.category == uniqueCategories[category_index])[0].value })
                                .attr('d', arc)
                                .attr("class", "circle_path")
                                .attr("identifier", this.categorySelected ? uniqueCategories[category_index] : uniqueGroup[groupIndex])
                                .style("stroke", "none")
                                .style('stroke-linejoin', 'round')
                                .style("stroke-width", 0)
                                .style("fill", this.visualSettings.radialSettings.colorScheme == "hexaColor" ? this.categorySelected ? this.selectedCategoryColor : viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex])[0].color : this.categorySelected ? getColor(this.selectedCategoryColor, color_index) : getColor(viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex])[0].color, color_index))
                                .style("fill-opacity", this.visualSettings.radialSettings.colorScheme == "hexaColor" ? color_index : 1)
                                .attr("id", "monthArc_" + groupIndex + "_" + category_index)
                                .attr('transform', 'translate(' + (wstart) + ',' + (hstart) + ')')
                                .call(updatearc, [groupIndex, category_index, calculated_category_values[category_index], (calculated_category_values[category_index] / category_limit)], "#monthArc_")
                                .on("click", () => {
        
                                    // the behaviour when clicking the bars, is the same as clicking the labels
                                    // when one bar is clicked, the visual moves to another level with the detailed categories
        
                                    if((this.existsSecondMeasure && this.visualSettings.radialSettings.activateDrilldown) || (!this.existsSecondMeasure && this.visualSettings.radialSettings.activateDrilldown)){
                                       
                                        if (!this.categorySelected) { // if there are no category selected, the visual appears normal, i.e., not filtered
                                            
                                            this.selectionManager.clear()
                                            const identity = viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex]).map(d => d.identity)
        
                                            return this.selectionManager.select(identity, true).then(() => {
                                                this.selectedCategoryName = uniqueGroup[groupIndex]
                                                this.selectedCategoryColor = viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex])[0].color
                                                this.categorySelected = this.categorySelected == false ? true : false
                                                this.last_step = "first"
                                                this.update(options);
                                            });
            
                                        } else {
        
                                            // In case one category is selected, the visual is filtered by that category 
        
                                            const identity = this.viewModel.dataPoints.filter(d => d.category == uniqueCategories[category_index])[0].identity
        
                                            if(this.identitySelected == identity){ // Click a category that is already selected, reset to default state
                                                this.selectionManager.clear()
                                                this.detailCategorySelected = false
                                                this.update(options);
                                            } else{
                                                this.identitySelected = identity
                                            
                                                if (this.last_step == "first") { // this allow us to know at which level are we in
                                                    this.last_step = "second"
                                                    this.selectionManager.clear()
                                                }
            
        
                                                if (!(event["ctrlKey"] || event["shiftKey"] || event["altKey"])) {
                                                    this.selectionManager.clear()
                                                    this.filteredCategories = []
                                                } 
        
        
        
        
                                                // if allow go back when clicking a category, the visual comes back to the first level, and it is not filtered
                                                if(!this.visualSettings.iconHome.allowGoBack_category) {
                                                    return this.selectionManager.select(identity, true).then((ids: powerbi.visuals.ISelectionId[]) => {
        
                                                        this.detailCategorySelected = true
        
                                                        this.filteredCategories.push(viewModel.dataPoints.filter(d => d.category == uniqueCategories[category_index])[0].category)
                    
                                                        d3.selectAll(".circle_path").style("fill-opacity", 0.2)
                    
                                                        for (let i = 0; i < ids.length; i++) {
                    
                                                            d3.select("#" + (event.target as HTMLElement).getAttribute("id")).style("fill-opacity", 1);
                                                            d3.selectAll("[identifier='" + viewModel.dataPoints.filter(d => d.identity == ids[i])[0].category + "']").style("fill-opacity", 1)
                                                        }
                    
                                                    });
                                                }
                                                else {
                                                    this.selectionManager.clear()
                                                    return handleMouseClick();
                                                }
                                            }
                                        }
                                    } else{
                                        console.log("NO SECOND LEVEL")
                                    }
                                })
        
                            this.tooltipServiceWrapper.addTooltip(this.svg.selectAll(".circle_path"),
                                (tooltipEvent: TooltipEventArgs<DataPoint>) => this.getTooltipData(tooltipEvent),
                                (tooltipEvent: TooltipEventArgs<DataPoint>) => this.getTooltipIdentity(tooltipEvent)
                            );
                        }
        
                        color_index = !this.categorySelected ? color_index + (viewModel.dataPoints.filter(d => d.os == (this.categorySelected ? uniqueCategories[category_index] : uniqueGroup[groupIndex])).filter(d => d.category == uniqueCategories[category_index])[0].value == 0 ? 0 : this.visualSettings.radialSettings.opacitySteps/100) : color_index + 0
                    }
        
                    if (this.visualSettings.targetSettings.showTarget && (this.visualSettings.targetSettings.targetType == "variable")) {  
        
                        // creates a line that shows where the target is
                        this.circle.append("line")
                            .attr("id", "targetLine" + groupIndex)
                            .attr("x1", calculateTargetPositions(groupIndex, this.existTargetMetric ? viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex])[0].target : this.visualSettings.targetSettings.fixedTarget)[0])
                            .attr("y1", calculateTargetPositions(groupIndex, this.existTargetMetric ? viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex])[0].target : this.visualSettings.targetSettings.fixedTarget)[1])
                            .attr("x2", calculateTargetPositions(groupIndex, this.existTargetMetric ? viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex])[0].target : this.visualSettings.targetSettings.fixedTarget)[2])
                            .attr("y2", calculateTargetPositions(groupIndex, this.existTargetMetric ? viewModel.dataPoints.filter(d => d.os == uniqueGroup[groupIndex])[0].target : this.visualSettings.targetSettings.fixedTarget)[3])
                            .attr("stroke-opacity", this.visualSettings.targetSettings.targetLineOpacity/100)
                            .attr("stroke-dasharray", 0)
                            .style("z-index", 9999)
                            .attr("stroke", this.visualSettings.targetSettings.targetLineColor)
                            .attr("stroke-width", this.visualSettings.targetSettings.targetLineWidth)
                            .attr("display", this.categorySelected ? "none" : "block")
                    }
        
        
                    if (this.visualSettings.radialSettings.shadowVisible == "shadow" && this.visualSettings.lineSettings.lineVisible) {
        
                        // creates a circle that borders the radial chart
                        this.background.append("path")
                            .attr("transform", 'translate(' + wstart + ',' + (hstart) + ')')
                            .attr("d", d3.arc()
                                .innerRadius(1 + (line_tickness * (uniqueGroup.length)))
                                .outerRadius(line_tickness * (uniqueGroup.length))
                                .startAngle(-6.28)     // It's in radian, so Pi = 3.14 = bottom.
                                .endAngle(-1.57)       // 2*Pi = 6.28 = top
                            )
                            .attr('stroke', this.visualSettings.lineSettings.linecolor)
                            .attr('fill', this.visualSettings.lineSettings.linecolor)
                            .attr("stroke-width", this.visualSettings.lineSettings.linethickness)
        
                    }
                }
        
                if (this.categorySelected) {
        
                    // when we are on the second level, we want to click on the blank space on the left and on the right 
                    // then two transparent clickable areas were created (one on the left and another on the right) so that is possible
                    
                    // Creates clickable area as a rectangle
                    this.svg.append("rect")
                        .attr("class", "buttonArea")
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("width", (calculateRadialPoints(4, 5)[0] + (-5)) - 25) //switched i for 6 (last label)
                        .attr("height", height)
                        .attr("fill", "transparent")
                        .attr("opacity", 0)
                        .on("click", () => {
                            
                            if(!this.visualSettings.iconHome.allowGoBack_blank_space){
                                if(this.detailCategorySelected){      // if there is a category selected, it deselects it
                                    this.selectionManager.clear()
                                    this.detailCategorySelected = false
                                    this.update(options);
                                }
                            }
                            else {
                                this.selectionManager.clear();
                                return handleMouseClick(); 
                            }
                        });
        
                    this.svg.append("rect")
                        .attr("class", "buttonArea")
                        .attr("x", calculateRadialPoints(0, 5)[0] + (-5) + 27) //switched i for 2 (third label))
                        .attr("y", 0)
                        .attr("width", (calculateRadialPoints(4, 5)[0] + (-5)))
                        .attr("height", height)
                        .attr("fill", "transparent")
                        .attr("opacity", 0)
                        .on("click", () => {
                            if(!this.visualSettings.iconHome.allowGoBack_blank_space){
                                if(this.detailCategorySelected){      // if there is a category selected, it deselects it
                                    this.selectionManager.clear()
                                    this.detailCategorySelected = false
                                    this.update(options);
                                }
                            }
                            else {
                                this.selectionManager.clear();
                                return handleMouseClick(); 
                            }
                        });
                            
                    // Create the go back icon using the base64 data URL
                    this.svg.append("svg:image")
                        .attr("class", "icons")
                        .attr("xlink:href", this.visualSettings.iconHome.defaultIcon)
                        .attr("x", width * (this.visualSettings.iconHome.x_position / 100))
                        .attr("y", height * (this.visualSettings.iconHome.y_position / 100))
                        .attr("width", this.visualSettings.iconHome.size + "px")
                        .attr("height", this.visualSettings.iconHome.size + "px")
                        .attr("transform", "rotate(90 " + (width * (this.visualSettings.iconHome.x_position / 100) + this.visualSettings.iconHome.size / 2) + " " + (height * (this.visualSettings.iconHome.y_position / 100) + this.visualSettings.iconHome.size / 2) + ")")
                        .on("click", () => {
                            this.selectionManager.clear();
                            return handleMouseClick();
                        });   
                                
                            
                    // Adds label under the icon indicating the category we are in
                    if(this.visualSettings.iconHome.show_label){
                        
                        this.svg.append("text")
                            .attr("class", "iconText")
                            .attr('x', width * (this.visualSettings.iconHome.x_position / 100) + this.visualSettings.iconHome.size / 2)
                            .attr('y', height * (this.visualSettings.iconHome.y_position / 100) + this.visualSettings.iconHome.size + 0.5 * this.visualSettings.iconHome.size)
                            .attr("text-anchor", "middle")
                            .attr("font-size", this.visualSettings.iconHome.label_size + 'pt')
                            .attr("font-weight", this.visualSettings.iconHome.textWeight ? "bold" : "normal")
                            .attr("text-decoration", this.visualSettings.iconHome.fontUnderline ? "underline": "normal")
                            .attr("font-style", this.visualSettings.iconHome.fontItalic ? "italic": "normal")
                            .style("font-family", this.visualSettings.iconHome.fontFamily)
                            .attr("fill", this.visualSettings.iconHome.fontColor)
                            .text(this.selectedCategoryName)
                            .on("click", () => {
                                this.selectionManager.clear();
                                return handleMouseClick();
                            }); 
                    }
        
                }
        
        
        
                if (this.visualSettings.numberLabels.showNumbers) {
        
                    // Adds the value to each category label
        
                    this.circle.selectAll(".label_numbers")
                        .data(labels)
                        .enter()
                        .append('text')
                        .attr("class", "label_numbers")
                        .attr("x", (d, i) => calculateRadialPoints(i - 2, 5)[0] + (i <= 3 ? i == 3 ? (+10) : (+5) : (-5)))
                        .attr("y", (d, i) => calculateRadialPoints(i - 2, 5)[1] + (i <= 3 ? (-5) : (+15)))
                        .style("z-index", "999999")
                        .attr("font-size", this.visualSettings.numberLabels.size + 'pt')
                        .attr("font-weight", this.visualSettings.numberLabels.textWeight ? "bold" : "normal")
                        .attr("text-decoration", this.visualSettings.numberLabels.fontUnderline ? "underline": "normal")
                        .attr("font-style", this.visualSettings.numberLabels.fontItalic ? "italic": "normal")
                        .style("font-family", this.visualSettings.numberLabels.fontFamily)
                        .style("fill", this.visualSettings.numberLabels.fontColor)
                        .style("text-anchor", (d, i) => i <= 3 ? "start" : "end")
                        .text(function (d) {
                            return d
                        });
                }
        
        
        
                if (this.visualSettings.targetSettings.showTarget && (this.visualSettings.targetSettings.targetType == "fixed")) {
        
                    // creates target line
                    this.circle.append("line")
                        .attr("id", "targetLine")
                        .attr("x1", wstart)
                        .attr("y1", hstart)
                        .attr("x2", calculateTargetPositions(uniqueGroup.length - 1, (this.existTargetMetric ? this.targetValue : this.visualSettings.targetSettings.fixedTarget))[2])
                        .attr("y2", calculateTargetPositions(uniqueGroup.length - 1, (this.existTargetMetric ? this.targetValue : this.visualSettings.targetSettings.fixedTarget))[3])
                        .attr("stroke-opacity", this.visualSettings.targetSettings.targetLineOpacity/100)
                        .attr("stroke-dasharray", 0)
                        .style("z-index", 99999)
                        .attr("stroke", this.visualSettings.targetSettings.targetLineColor)
                        .attr("stroke-width", this.visualSettings.targetSettings.targetLineWidth)
                        .attr("display", this.categorySelected ? "none" : "block")
                    
        
        
        
        
                    // Adds a label to the target line with the target value
                    const targetLineLabel = this.background
                        .append("text")
                        .attr("id", "targetLineLabel")
                        .attr("x", () => {
                            const textProperties = {
                                text: this.visualSettings.targetTitle.title,
                                fontFamily: this.visualSettings.targetTitle.fontFamily,
                                fontSize: this.visualSettings.targetTitle.fontSize + "pt",
                                fontStyle: this.visualSettings.targetTitle.textWeight ? "bold" : "normal"
                            };
        
                            const labelWidth = textMeasurementService.measureSvgTextWidth(textProperties);
                            const xPosition = calculateTargetPositions(uniqueGroup.length - 1, this.existTargetMetric ? this.targetValue : this.visualSettings.targetSettings.fixedTarget)[2];
        
                            return xPosition + (xPosition > (width * 0.5) ? (labelWidth * 0.1) : -(labelWidth * 0.1));
                        })
                        .attr("y", () => {
                            const textProperties = {
                                text: this.visualSettings.targetTitle.title,
                                fontFamily: this.visualSettings.targetTitle.fontFamily,
                                fontSize: this.visualSettings.targetTitle.fontSize + "pt",
                                fontWeight: this.visualSettings.targetTitle.textWeight ? "bold" : "normal"
                            };
        
                            const labelHeight = textMeasurementService.measureSvgTextHeight(textProperties);
                            const yPosition = calculateTargetPositions(uniqueGroup.length - 1, this.existTargetMetric ? this.targetValue : this.visualSettings.targetSettings.fixedTarget)[3];
        
                            return yPosition + (yPosition > (height * 0.5) ? labelHeight : 0);
                        })
                        .attr("fill", this.visualSettings.targetTitle.fontColor)
                        .attr("text-anchor", () => {
                            const xPosition = calculateTargetPositions(uniqueGroup.length - 1, this.existTargetMetric ? this.targetValue : this.visualSettings.targetSettings.fixedTarget)[2];
                            return xPosition > (width * 0.5) ? "start" : "end";
                        })
                        .attr("display", this.categorySelected ? "none" : "block")
        
                    // Append Title as a separate <tspan>
                    targetLineLabel.append("tspan")
                        .attr("fill", this.visualSettings.targetTitle.fontColor)  // Allow different color for title
                        .attr("font-size", this.visualSettings.targetTitle.fontSize + 'pt')  // Separate font size for title
                        .attr("font-weight", this.visualSettings.targetTitle.textWeight ? "bold" : "normal")  // Apply bold or normal
                        .attr("text-decoration", this.visualSettings.targetTitle.fontUnderline ? "underline" : "none")  // Apply underline if enabled
                        .attr("font-style", this.visualSettings.targetTitle.fontItalic ? "italic" : "normal")  // Apply italic if enabled
                        .style("font-family", this.visualSettings.targetTitle.fontFamily)  // Separate font family for title
                        .text(this.visualSettings.targetTitle.title);
        
                    // Append Value as a separate <tspan>  
                    targetLineLabel.append("tspan")
                        .attr("dx", 5)  // Add spacing between title and value
                        .attr("fill", this.visualSettings.targetSettings.fontColor)  // Allow different color for value
                        .attr("font-size", this.visualSettings.targetSettings.fontSize + 'pt')  // Separate font size for value
                        .attr("font-weight", this.visualSettings.targetSettings.textWeight ? "bold" : "normal")  // Apply bold or normal
                        .attr("text-decoration", this.visualSettings.targetSettings.fontUnderline ? "underline" : "none")  // Apply underline if enabled
                        .attr("font-style", this.visualSettings.targetSettings.fontItalic ? "italic" : "normal")  // Apply italic if enabled
                        .style("font-family", this.visualSettings.targetSettings.fontFamily)  // Separate font family for value
                        .text(this.formatValue((this.existTargetMetric ? this.targetValue : this.visualSettings.targetSettings.fixedTarget), this.defaultCubeFormat, this.visualSettings.targetSettings.decimalPlaces, this.visualSettings.targetSettings.quarterUnits));
        
                            
        
        
        
                }
        
                //handle context menu
                this.svg.on('contextmenu', (event: MouseEvent) => { 
                    const eventTarget = event.target as SVGElement; // Use a more specific type
                    const dataPoint = d3.select<SVGElement, datum>(eventTarget).datum();
                    
                    this.selectionManager.showContextMenu(dataPoint ? dataPoint.identity : {}, {
                        x: event.clientX,
                        y: event.clientY
                    });
                
                    event.preventDefault();
                });
                
        
        
        
        
        
                /**
                 * Function Name: calculateRadialPoints
                 * Description: Calculates the coordinates of a point on a radial line at a given position.
                 *
                 * @param {number} position - The position of the point on the radial line.
                 * @param {number} outMargin - The margin outside the radial line.
                 * @returns {number[]} - An array containing the x and y coordinates of the calculated point.
                 */
        
                function calculateRadialPoints(position, outMargin) {
                    const cx = wstart
                    const cy = hstart
                    const r = line_tickness * (uniqueGroup.length) + outMargin //--radius--
                    const angle = Math.PI * 0.25 //---angle between each line---
        
        
                    const x2 = r * Math.cos(angle * position) + cx
                    const y2 = r * Math.sin(angle * position) + cy
        
                    
                    return [x2, y2]
                }
                
        
                /**
                 * Function Name: calculateTargetPositions
                 * Description: Calculates the coordinates of two points for a target line based on position and target values.
                 *
                 * @param {number} position - The position of the target line.
                 * @param {number} target - The target value.
                 * @returns {number[]} - An array containing the x and y coordinates of the starting and ending points of the target line.
                 */
                function calculateTargetPositions(position, target) {
                    const degree =  270 - ((270 * ((target / calculatedTotal) * 100)) / 100)
                    const r2 = line_tickness * (position + 1)
                    const r1 = line_tickness * (position) + (line_tickness * 0.1)//--radius--
        
                    const rad = (270 + degree) * Math.PI / 180;
                    const x1 = wstart + Math.sin(rad) * r1
                    const y1 = hstart + Math.cos(rad) * r1;
                    const x2 = wstart + Math.sin(rad) * r2;
                    const y2 = hstart + Math.cos(rad) * r2;
                    return [x1, y1, x2, y2]
                }
        
        
                /**
                 * Function Name: getColor
                 * Description: Returns an interpolated color based on the input color name and index.
                 *
                 * @param {string} color - The name of the color palette (e.g., "blue", "green").
                 * @param {number} color_index - The index of the color within the palette.
                 * @returns {string} - The interpolated color value.
                 */
                function getColor(color: string, color_index: number) {
                    if (color == "blue") {
                        return d3.interpolateBlues(color_index)
                    } else if (color == "green") {
                        return d3.interpolateGreens(color_index)
                    } else if (color == "purple") {
                        return d3.interpolatePurples(color_index)
                    } else if (color == "red") {
                        return d3.interpolateReds(color_index)
                    } else if (color == "grey") {
                        return d3.interpolateGreys(color_index)
                    } else if (color == "orange") {
                        return d3.interpolateOranges(color_index)
                    } else if (color == "bugn") {
                       
                        return d3.interpolateBuGn(color_index)
                    } else if (color == "bupu") {
                        return d3.interpolateBuPu(color_index)
                    } else if (color == "gnbu") {
                      
                        return d3.interpolateGnBu(color_index)
                    } else if (color == "orrd") {
        
                        return d3.interpolateOrRd(color_index)
                    } else if (color == "pubugn") {
                        return d3.interpolatePuBuGn(color_index)
                    } else if (color == "pubu") {
                        return d3.interpolatePuBu(color_index)
                    } else if (color == "purd") {
                        return d3.interpolatePuRd(color_index)
                    } else if (color == "rdpu") {
                        return d3.interpolateRdPu(color_index)
                    } else if (color == "ylgnbu") {
                        return d3.interpolateYlGnBu(color_index)
                    } else if (color == "ylgn") {
                        return d3.interpolateYlGn(color_index)
                    } else if (color == "ylorbr") {
                        return d3.interpolateYlOrBr(color_index)
                    } else if (color == "ylorrd") {
                        return d3.interpolateYlOrRd(color_index)
                    } else {
                        return d3.interpolateRainbow(color_index)
                    }
                }
        
        
                /**
                 * Function Name: arcTween
                 * Description: Defines a tweening function for transitioning between two arc shapes.
                 *
                 * @param {d3.Transition<SVGPathElement, any, any, any>} transition - The D3 transition object.
                 * @param {number[]} arr - An array containing parameters for the transition (e.g., new end angle and arc generator).
                 */
                function arcTween(transition, arr): void {
        
                    transition.attrTween('d', (d) => {
                        const interpolate = d3.interpolate(0, arr[0]);
        
                        return (t) => {
        
                            d.endAngle = interpolate(t);
                            return arr[1](d);
        
                        };
                    });
                }
            }
        }



    }


    /**
     * Function Name: getFormattingModel
     * Description: Retrieves the formatting model for the visual, which includes formatting settings for cards and slices.
     *
     * @returns {powerbi.visuals.FormattingModel} - The formatting model containing formatting settings.
     */
     public getFormattingModel(): powerbi.visuals.FormattingModel {

        // CARD MAXIMUM VALUE
        const max_value: powerbi.visuals.FormattingCard = {
            description: "Maximum Value Settings",
            displayName: "Maximum Value",
            uid: "max_value_uid",
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "generalView",
                    propertyName: "totalValueType"
                },
                {
                    objectName: "generalView",
                    propertyName: "categoryToTotal",
                },
                {
                    objectName: "generalView",
                    propertyName: "fixedTotal"
                }
            ]
        }

        // GROUPS FOR CARD MAXIMUM VALUE
        const group_max_value_general: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "maxValue_general",
            slices: [
                {
                    displayName: "Total Value",
                    uid: "total_value_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "generalView",
                                propertyName: "totalValueType"
                            },
                            value: this.visualSettings.generalView.totalValueType
                         }
                    }
                }
            ]
        };


        // SLICES FOR CARD MAXIMUM VALUE 
        if (this.visualSettings.generalView.totalValueType == "sum") {

            for (const group of this.totalByCategory.filter(d => d.group != "total")) {

                group_max_value_general.slices.push({                 
                    displayName: group.group,
                    uid: "fixed_total_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "generalView",
                                propertyName: "categoryToTotal",
                                selector: group.identity.getSelector()
                            },
                            value: group.active
                            }
                    }
                })

            }  
        } else if (this.visualSettings.generalView.totalValueType == "fixed") {

            group_max_value_general.slices.push({                 
                    displayName: "Maximum Total",
                    uid: "fixed_total_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "generalView",
                                propertyName: "fixedTotal"
                            },
                            value: this.visualSettings.generalView.fixedTotal
                            }
                    }
                })

        }
        

        max_value.groups.push(group_max_value_general);





    
        // CARD LABEL
        const label: powerbi.visuals.FormattingCard = {
            description: "Label Settings",
            displayName: "Data Labels",
            uid: "label_uid",
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "labelFormatting",
                    propertyName: "showLabels"
                },
                {
                    objectName: "labelFormatting",
                    propertyName: "labelAlignment"
                },
                {
                    objectName: "labelFormatting",
                    propertyName: "displayUnits"
                },
                {
                    objectName: "labelFormatting",
                    propertyName: "decimalPlaces"
                },
                {
                    objectName: "labelFormatting",
                    propertyName: "labelAlignment"
                },
                {
                    objectName: "labelFormatting",
                    propertyName: "fontColor"
                },
                {
                    objectName: "labelFormatting",
                    propertyName: "fontFamily"
                },
                {
                    objectName: "labelFormatting",
                    propertyName: "size"
                },
                {
                    objectName: "labelFormatting",
                    propertyName: "textWeight"
                },
            ]
        }
        

        // GROUPS FOR CARD LABEL
        const group_options: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "label_options",
            slices: [
                {
                    displayName: "Show Labels",
                    uid: "show_labels_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "labelFormatting",
                                propertyName: "showLabels"
                            },
                            value: this.visualSettings.labelFormatting.showLabels
                        }
                    }
                },
                {                    
                    displayName: "Alignment",
                    uid: "alignment_slice",
                    disabled: (this.visualSettings.labelFormatting.showLabels || this.visualSettings.labelValueFormatting.showLabels) ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.AlignmentGroup,
                        properties: {
                            descriptor:
                            {
                                objectName: "labelFormatting",
                                propertyName: "labelAlignment"
                            },
                            mode: powerbi.visuals.AlignmentGroupMode.Horizonal,
                            value: this.visualSettings.labelFormatting.labelAlignment
                        }
                    }
                }
            ]
        };

        const group_text: powerbi.visuals.FormattingGroup = {
            displayName: "Text",
            uid: "label_text",
            disabled: this.visualSettings.labelFormatting.showLabels ? false : true,
            slices: [
                {                    
                    displayName: "Color",
                    uid: "label_color",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "labelFormatting",
                                propertyName: "fontColor"
                            },
                            value: { value: this.visualSettings.labelFormatting.fontColor }
                        }
                    }
                },
                {
                    uid: "label_text_control",
                    displayName: "Font",
                    control: {
                        type: powerbi.visuals.FormattingComponent.FontControl,
                        properties: {
                            fontFamily: {
                                descriptor: {
                                    objectName: "labelFormatting",
                                    propertyName: "fontFamily"
                                },
                                value: this.visualSettings.labelFormatting.fontFamily
                            },
                            fontSize: {
                                descriptor: {
                                    objectName: "labelFormatting",
                                    propertyName: "size"
                                },
                                value: this.visualSettings.labelFormatting.size
                            },
                            bold: {
                                descriptor: {
                                    objectName: "labelFormatting",
                                    propertyName: "textWeight"
                                },
                                value: this.visualSettings.labelFormatting.textWeight
                            },
                            italic: {
                                descriptor: {
                                    objectName: "labelFormatting",
                                    propertyName: "fontItalic"
                                },
                                value: this.visualSettings.labelFormatting.fontItalic
                            },
                            underline: {
                                descriptor: {
                                    objectName: "labelFormatting",
                                    propertyName: "fontUnderline"
                                },
                                value: this.visualSettings.labelFormatting.fontUnderline
                        }
                        }
                    }
                }
            ]
        };

        label.groups.push(group_options);
        label.groups.push(group_text);











        // CARD VALUE LABEL
        const labelValue: powerbi.visuals.FormattingCard = {
            description: "Label Value Settings",
            displayName: "Data Values Labels",
            uid: "labelValue_uid",
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "labelValueFormatting",
                    propertyName: "showLabels"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "showPercentages"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "displayUnits"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "decimalPlaces"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "fontColor"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "fontFamily"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "size"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "textWeight"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "fontItalic"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "fontUnderline"
                }
            ]
        }
        

        // GROUPS FOR CARD LABEL
        const group_labelValue_options: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "group_labelValue_options",
            slices: [
                {
                    displayName: "Show Labels",
                    uid: "show_labels_slice_labelValue",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "labelValueFormatting",
                                propertyName: "showLabels"
                            },
                            value: this.visualSettings.labelValueFormatting.showLabels
                        }
                    }
                }
            ]
        };

        const group_labelValue_text: powerbi.visuals.FormattingGroup = {
            displayName: "Text",
            uid: "group_labelValue_text",
            disabled: this.visualSettings.labelValueFormatting.showLabels ? false : true,
            slices: [
                {                    
                    displayName: "Color",
                    uid: "label_color_labelValue",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "labelValueFormatting",
                                propertyName: "fontColor"
                            },
                            value: { value: this.visualSettings.labelValueFormatting.fontColor }
                        }
                    }
                },
                {
                    uid: "label_text_control_labelValue",
                    displayName: "Font",
                    control: {
                        type: powerbi.visuals.FormattingComponent.FontControl,
                        properties: {
                            fontFamily: {
                                descriptor: {
                                    objectName: "labelValueFormatting",
                                    propertyName: "fontFamily"
                                },
                                value: this.visualSettings.labelValueFormatting.fontFamily
                            },
                            fontSize: {
                                descriptor: {
                                    objectName: "labelValueFormatting",
                                    propertyName: "size"
                                },
                                value: this.visualSettings.labelValueFormatting.size
                            },
                            bold: {
                                descriptor: {
                                    objectName: "labelValueFormatting",
                                    propertyName: "textWeight"
                                },
                                value: this.visualSettings.labelValueFormatting.textWeight
                            },
                            italic: {
                                descriptor: {
                                    objectName: "labelValueFormatting",
                                    propertyName: "fontItalic"
                                },
                                value: this.visualSettings.labelValueFormatting.fontItalic
                            },
                            underline: {
                                descriptor: {
                                    objectName: "labelValueFormatting",
                                    propertyName: "fontUnderline"
                                },
                                value: this.visualSettings.labelValueFormatting.fontUnderline
                        }
                        }
                    }
                }
            ]
        };

        const group_labelValue_format: powerbi.visuals.FormattingGroup = {
            displayName: "Format",
            uid: "group_labelValue_format",
            disabled: this.visualSettings.labelValueFormatting.showLabels ? false : true,
            slices: [
                {                    
                    displayName: "Format",
                    uid: "showPercentages_slice_labelValue",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "labelValueFormatting",
                                propertyName: "showPercentages"
                            },
                            value: this.visualSettings.labelValueFormatting.showPercentages
                        }
                    }
                },
                {                    
                    displayName: "Units",
                    uid: "display_units_slice_labelValue",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "labelValueFormatting",
                                propertyName: "displayUnits"
                            },
                            value: this.visualSettings.labelValueFormatting.displayUnits
                        }
                    }
                },
                {
                    displayName: "Decimal Places",
                    uid: "label_decimalPlaces_labelValue",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "labelValueFormatting",
                                propertyName: "decimalPlaces"
                            },
                            value: this.visualSettings.labelValueFormatting.decimalPlaces
                        }
                    }
                }
            ]
        };

        labelValue.groups.push(group_labelValue_options);
        labelValue.groups.push(group_labelValue_format);
        labelValue.groups.push(group_labelValue_text);







        // CARD SEPARATOR LABEL
        const labelSeparator: powerbi.visuals.FormattingCard = {
            description: "Label Separator Settings",
            displayName: "Data Separator Label",
            uid: "labelSeparator_uid",
            disabled: (this.visualSettings.labelValueFormatting.showLabels && this.visualSettings.labelFormatting.showLabels) ? false : true,
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "labelValueFormatting",
                    propertyName: "fontColor"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "fontFamily"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "size"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "textWeight"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "fontItalic"
                },
                {
                    objectName: "labelValueFormatting",
                    propertyName: "fontUnderline"
                }
            ]
        }



        const group_labelSeparator_text: powerbi.visuals.FormattingGroup = {
            displayName: "Text",
            uid: "group_labelSeparator_text",
            slices: [
                {                    
                    displayName: "Color",
                    uid: "label_color_labelSeparator",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "labelSeparator",
                                propertyName: "fontColor"
                            },
                            value: { value: this.visualSettings.labelSeparator.fontColor }
                        }
                    }
                },
                {
                    uid: "label_text_control_labelSeparator",
                    displayName: "Font",
                    control: {
                        type: powerbi.visuals.FormattingComponent.FontControl,
                        properties: {
                            fontFamily: {
                                descriptor: {
                                    objectName: "labelSeparator",
                                    propertyName: "fontFamily"
                                },
                                value: this.visualSettings.labelSeparator.fontFamily
                            },
                            fontSize: {
                                descriptor: {
                                    objectName: "labelSeparator",
                                    propertyName: "size"
                                },
                                value: this.visualSettings.labelSeparator.size
                            },
                            bold: {
                                descriptor: {
                                    objectName: "labelSeparator",
                                    propertyName: "textWeight"
                                },
                                value: this.visualSettings.labelSeparator.textWeight
                            },
                            italic: {
                                descriptor: {
                                    objectName: "labelSeparator",
                                    propertyName: "fontItalic"
                                },
                                value: this.visualSettings.labelSeparator.fontItalic
                            },
                            underline: {
                                descriptor: {
                                    objectName: "labelSeparator",
                                    propertyName: "fontUnderline"
                                },
                                value: this.visualSettings.labelSeparator.fontUnderline
                            }
                        }
                    }
                }
            ]
        };

        labelSeparator.groups.push(group_labelSeparator_text)









        // CARD NUMBER LABELS QUARTERS
        const number_labels: powerbi.visuals.FormattingCard = {
            description: "Number Labels Quarters Settings",
            displayName: "Number Labels",
            uid: "number_labels_quarters_uid",
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "numberLabels",
                    propertyName: "showNumbers"
                },
                {
                    objectName: "numberLabels",
                    propertyName: "fontColor"
                },
                {
                    objectName: "numberLabels",
                    propertyName: "fontFamily"
                },
                {
                    objectName: "numberLabels",
                    propertyName: "size"
                },
                {
                    objectName: "numberLabels",
                    propertyName: "textWeight"
                },
                {
                    objectName: "numberLabels",
                    propertyName: "fontItalic"
                },
                {
                    objectName: "numberLabels",
                    propertyName: "fontUnderline"                    
                },
                {
                    objectName: "numberLabels",
                    propertyName: "quarterUnits"
                },
                {
                    objectName: "numberLabels",
                    propertyName: "decimalPlaces"
                },


            ]
        }

        // GROUPS FOR CARD NUMBER LABELS QUARTERS
        const group_number_labels_general: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "number_labels_general",
            slices: [
                {
                    displayName: "Show Numbers",
                    uid: "show_numbers_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "numberLabels",
                                propertyName: "showNumbers"
                            },
                            value: this.visualSettings.numberLabels.showNumbers
                        }
                    }
                },
            ]
        };


        const group_number_labels_text: powerbi.visuals.FormattingGroup = {
            displayName: "Text",
            uid: "number_labels_text",
            disabled: this.visualSettings.numberLabels.showNumbers ? false : true,
            slices: [
                {                    
                    displayName: "Color",
                    uid: "number_label_color",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "numberLabels",
                                propertyName: "fontColor"
                            },
                            value: { value: this.visualSettings.numberLabels.fontColor}
                        }
                    }
                },
                {
                    uid: "number_labels_control",
                    displayName: "Font",
                    control: {
                        type: powerbi.visuals.FormattingComponent.FontControl,
                        properties: {
                            fontFamily: {
                                descriptor: {
                                    objectName: "numberLabels",
                                    propertyName: "fontFamily"
                                },
                                value: this.visualSettings.numberLabels.fontFamily
                            },
                            fontSize: {
                                descriptor: {
                                    objectName: "numberLabels",
                                    propertyName: "size"
                                },
                                value: this.visualSettings.numberLabels.size
                            },
                            bold: {
                                descriptor: {
                                    objectName: "numberLabels",
                                    propertyName: "textWeight"
                                },
                                value: this.visualSettings.numberLabels.textWeight
                            },
                            italic: {
                                descriptor: {
                                    objectName: "numberLabels",
                                    propertyName: "fontItalic"
                                },
                                value: this.visualSettings.numberLabels.fontItalic
                            },
                            underline: {
                                descriptor: {
                                    objectName: "numberLabels",
                                    propertyName: "fontUnderline"
                                },
                                value: this.visualSettings.numberLabels.fontUnderline
                        }
                        }
                    }
                }                
            ]
        };


        const group_number_labels_format: powerbi.visuals.FormattingGroup = {
            displayName: "Format",
            uid: "number_labels_format",
            disabled: this.visualSettings.numberLabels.showNumbers ? false : true,
            slices: [
                {                    
                    displayName: "Units",
                    uid: "quarter_display_units_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "numberLabels",
                                propertyName: "quarterUnits"
                            },
                            value: this.visualSettings.numberLabels.quarterUnits
                        }
                    }
                },
                {
                    displayName: "Decimal Places",
                    uid: "number_label_decimalPlaces",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "numberLabels",
                                propertyName: "decimalPlaces"
                            },
                            value: this.visualSettings.numberLabels.decimalPlaces
                        }
                    }
                }   
            ]
        };


           
        number_labels.groups.push(group_number_labels_general);   
        number_labels.groups.push(group_number_labels_text);  
        number_labels.groups.push(group_number_labels_format); 






        // CARD RADIAL BAR
        const radial_bar: powerbi.visuals.FormattingCard = {
            description: "Radial Bar Settings",
            displayName: "Radial Bar",
            uid: "radial_bar_uid",
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "radialSettings",
                    propertyName: "activateDrilldown"
                },
                {
                    objectName: "radialSettings",
                    propertyName: "radius"
                },
                {
                    objectName: "radialSettings",
                    propertyName: "startingOpacity",
                },
                {
                    objectName: "radialSettings",
                    propertyName: "opacitySteps",
                },
                {
                    objectName: "radialSettings",
                    propertyName: "shadowVisible"
                },
                {
                    objectName: "radialSettings",
                    propertyName: "shadowColor",
                },
                {
                    objectName: "group_radial_bar_shadow",
                    propertyName: "shadowOpacity",
                },
                {
                    objectName: "radialSettings",
                    propertyName: "colorScheme"
                },
                {
                    objectName: "radialSettings",
                    propertyName: "color"
                },
                {
                    objectName: "radialSettings",
                    propertyName: "hexaColor"
                },
                {
                    objectName: "radialSettings",
                    propertyName: "color_alternative"
                },
            ]
        }

        // GROUPS FOR RADIAL BAR
        const group_radial_bar_general: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "radial_bar_general",
            slices: [
                {
                    displayName: "Enable Drill Down",
                    uid: "drill_down_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "radialSettings",
                                propertyName: "activateDrilldown"
                            },
                            value: this.visualSettings.radialSettings.activateDrilldown
                        }
                    }
                },
            ]
        }; 

        const group_radial_bar_design: powerbi.visuals.FormattingGroup = {
            displayName: "Design",
            uid: "radial_bar_design",
            slices: [
                {
                    displayName: "Border Curveness",
                    uid: "border_curveness_slider",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "radialSettings",
                                propertyName: "radius"
                            },
                            value: this.visualSettings.radialSettings.radius
                        }
                    }
                },
                {
                    displayName: "Starting Opacity",
                    uid: "bar_opacity",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Slider,
                        properties: {
                            descriptor:
                            {
                                objectName: "radialSettings",
                                propertyName: "startingOpacity",
                            },
                            value: this.visualSettings.radialSettings.startingOpacity
                        }
                    }
                },
                {
                    displayName: "Step incrementation for color schemes",
                    uid: "step_incremnetation_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Slider,
                        properties: {
                            descriptor:
                            {
                                objectName: "radialSettings",
                                propertyName: "opacitySteps",
                            },
                            value: this.visualSettings.radialSettings.opacitySteps
                        }
                    }
                }
            ]
        }; 

        const group_radial_bar_shadow: powerbi.visuals.FormattingGroup = {
            displayName: "Background",
            uid: "radial_bar_shadow",
            slices: [
                {                    
                    displayName: "Type of Background",
                    uid: "backgroud_type_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "radialSettings",
                                propertyName: "shadowVisible"
                            },
                            value: this.visualSettings.radialSettings.shadowVisible
                        }
                    }
                },
                {
                    displayName: "Color",
                    uid: "shadow_color",
                    disabled: this.visualSettings.radialSettings.shadowVisible == "shadow" ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "radialSettings",
                                propertyName: "shadowColor",
                            },
                            value: { value: this.visualSettings.radialSettings.shadowColor }
                        }
                    }
            
                },
                {
                    displayName: "Opacity",
                    uid: "shadow_opacity",
                    disabled: this.visualSettings.radialSettings.shadowVisible == "shadow" ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.Slider,
                        properties: {
                            descriptor:
                            {
                                objectName: "group_radial_bar_shadow",
                                propertyName: "shadowOpacity",
                            },
                            value: this.visualSettings.radialSettings.shadowOpacity
                        }
                    }
                }
            ]
        };

        const group_radial_bar_colors: powerbi.visuals.FormattingGroup = {
            displayName: "Colors",
            uid: "radial_bar_colors_jidfhuidrfghdrfgu",
            slices: [
                {                    
                    displayName: "Color Scheme",
                    uid: "color_scheme_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "radialSettings",
                                propertyName: "colorScheme"
                            },
                            value: this.visualSettings.radialSettings.colorScheme
                        }
                    }
                },
            ]
        };   
        

        for (const object of this.viewModel.dataPoints.map(d => d.os).filter(this.onlyUnique)) {
            
            if (this.visualSettings.radialSettings.colorScheme == "color"){

                group_radial_bar_colors.slices.push(

                    {
                        displayName: object + " Color",
                        uid: "color",
                        control: {
                            type: powerbi.visuals.FormattingComponent.Dropdown,
                            properties: {
                                descriptor:
                                {
                                    objectName: "radialSettings",
                                    propertyName: "color",
                                    selector: this.viewModel.dataPoints.filter(d => d.os == object)[0].identity.getSelector()
                                },
                                value: this.viewModel.dataPoints.filter(d => d.os == object)[0].color 
                            }
                        }
                    }
                )
            } else if (this.visualSettings.radialSettings.colorScheme == "hexaColor"){
                group_radial_bar_colors.slices.push(

                    {
                        displayName: object + " Color",
                        uid: "hexacolor",
                        control: {
                            type: powerbi.visuals.FormattingComponent.ColorPicker,
                            properties: {
                                descriptor:
                                {
                                    objectName: "radialSettings",
                                    propertyName: "hexaColor",
                                    selector: this.viewModel.dataPoints.filter(d => d.os == object)[0].identity.getSelector()
                                },
                                value: { value: this.viewModel.dataPoints.filter(d => d.os == object)[0].color }
                            }
                        }                        
                    }

                )
            } else {

                group_radial_bar_colors.slices.push(

                    {
                        displayName: object + " Color",
                        uid: "color_alternative",
                        control: {
                            type: powerbi.visuals.FormattingComponent.Dropdown,
                            properties: {
                                descriptor:
                                {
                                    objectName: "radialSettings",
                                    propertyName: "color_alternative",
                                    selector: this.viewModel.dataPoints.filter(d => d.os == object)[0].identity.getSelector()
                                },
                                value: this.viewModel.dataPoints.filter(d => d.os == object)[0].color 
                            }
                        }                        
                    }

                )

            }
        }



        radial_bar.groups.push(group_radial_bar_general);  
        radial_bar.groups.push(group_radial_bar_design);  
        radial_bar.groups.push(group_radial_bar_colors);  
        radial_bar.groups.push(group_radial_bar_shadow);  




        //CARD OUTSIDE CIRCLE
        const outside_circle: powerbi.visuals.FormattingCard = {
            description: "Outside Circle Settings",
            displayName: "Outside Circle",
            uid: "outside_circle_uid",            
            disabled: this.visualSettings.radialSettings.shadowVisible == "shadow" ? false : true,
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "lineSettings",
                    propertyName: "lineVisible",
                },
                {
                    objectName: "lineSettings",
                    propertyName: "linecolor"
                },
                {
                    objectName: "lineSettings",
                    propertyName: "linethickness"
                }
            ]
        }

        const group_outside_circle: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "outside_circle",
            slices: [
                {
                    displayName: "Show line",
                    uid: "show_line_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "lineSettings",
                                propertyName: "lineVisible",
                            },
                            value: this.visualSettings.lineSettings.lineVisible
                         }
                    }
                }
            ]
        }; 
        
        const group_outside_circle_design: powerbi.visuals.FormattingGroup = {
            displayName: "Design",
            uid: "outside_circle_design",
            disabled: this.visualSettings.lineSettings.lineVisible ? false : true,
            slices: [
                {
                    displayName: "Color",
                    uid: "outside_line_color_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "lineSettings",
                                propertyName: "linecolor"
                            },
                            value: { value: this.visualSettings.lineSettings.linecolor }
                        }
                    }                        
                },
                {
                    displayName: "Width",
                    uid: "outside_line_tickness_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "lineSettings",
                                propertyName: "linethickness"
                            },
                            value: this.visualSettings.lineSettings.linethickness 
                        }
                    }                        
                }
            ]
        }; 




        outside_circle.groups.push(group_outside_circle); 
        outside_circle.groups.push(group_outside_circle_design); 
        

        
        
          





        //CARD OUTSIDE CIRCLE
        const quarter_reference: powerbi.visuals.FormattingCard = {
            description: "Quarter Reference Settings",
            displayName: "Quarter Reference Line",
            uid: "quarter_reference_uid",
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "referenceLine",
                    propertyName: "showReferenceLines",
                },
                {
                    objectName: "referenceLine",
                    propertyName: "sonarLinesColor"
                },
                {
                    objectName: "referenceLine",
                    propertyName: "dashline"
                },
                {
                    objectName: "referenceLine",
                    propertyName: "sonarLineWidth"
                },
                {
                    objectName: "referenceLine",
                    propertyName: "sonarOpacity"
                },
            ]
        }


        const group__quarter_reference_line: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "quarter_reference_uid",
            slices: [
                {
                    displayName: "Show Reference Lines",
                    uid: "show_reference_line_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "referenceLine",
                                propertyName: "showReferenceLines",
                            },
                            value: this.visualSettings.referenceLine.showReferenceLines
                         }
                    }
                }
            ]
        };

        const group__quarter_reference_line_design: powerbi.visuals.FormattingGroup = {
            displayName: "Design",
            uid: "quarter_reference_design_uid",
            disabled: this.visualSettings.referenceLine.showReferenceLines ? false : true,
            slices: [
                {
                    displayName: "Color",
                    uid: "reference_line_color_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "referenceLine",
                                propertyName: "sonarLinesColor"
                            },
                            value: { value: this.visualSettings.referenceLine.sonarLinesColor }
                        }
                    }                        
                },
                {
                    displayName: "Dash Interval",
                    uid: "dash_interval_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "referenceLine",
                                propertyName: "dashline"
                            },
                            value: this.visualSettings.referenceLine.dashline
                        }
                    }                        
                },
                {
                    displayName: "Width",
                    uid: "reference_line_Width_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "referenceLine",
                                propertyName: "sonarLineWidth"
                            },
                            value: this.visualSettings.referenceLine.sonarLineWidth
                        }
                    }                        
                },
                {
                    displayName: "Opacity",
                    uid: "reference_line_opacity_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Slider,
                        properties: {
                            descriptor:
                            {
                                objectName: "referenceLine",
                                propertyName: "sonarOpacity"
                            },
                            value: this.visualSettings.referenceLine.sonarOpacity
                        }
                    }                        
                }
            ]
        };

        quarter_reference.groups.push(group__quarter_reference_line);  
        quarter_reference.groups.push(group__quarter_reference_line_design);   





        // CARD GO BACK ARROW
        const goBack_arrow: powerbi.visuals.FormattingCard = {
        description: "Icon Settings",
        displayName: "Go Back",
        uid: "goBack_uid",
        groups: [],
        revertToDefaultDescriptors: [
            {
                objectName: "iconHome",
                propertyName: "size"
            },
            {
                objectName: "iconHome",
                propertyName: "icon"
            },
            {
                objectName: "iconHome",
                propertyName: "allowGoBack_category",
            },
            {
                objectName: "iconHome",
                propertyName: "allowGoBack_label",
            },
            {
                objectName: "iconHome",
                propertyName: "default_icon",
            },
            {
                objectName: "iconHome",
                propertyName: "show_label",
            },
            {
                objectName: "iconHome",
                propertyName: "allowGoBack_blank_space",
            },
            {
                objectName: "iconHome",
                propertyName: "y_position"
            },
            {
                objectName: "iconHome",
                propertyName: "x_position",
            },
            {
                objectName: "iconHome",
                propertyName: "fontColor"
            },
            {
                objectName: "iconHome",
                propertyName: "fontFamily"
            },
            {
                objectName: "iconHome",
                propertyName: "label_size"
            },
            {
                objectName: "iconHome",
                propertyName: "textWeight"
            },
            {
                objectName: "iconHome",
                propertyName: "fontItalic"
            },
            {
                objectName: "iconHome",
                propertyName: "fontUnderline"
            },
        ]
        }

        // GROUPS FOR GO BACK ARROW
        const goBack_settings: powerbi.visuals.FormattingGroup = {
            displayName: "When",
            uid: "goBack_settings",
            slices: [
                {
                    displayName: "Clicking Bar",
                    uid: "back_when_click_category_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "iconHome",
                                propertyName: "allowGoBack_category",
                            },
                            value: this.visualSettings.iconHome.allowGoBack_category
                            }
                    }
                },
                {
                    displayName: "Clicking Label",
                    uid: "back_when_click_label_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "iconHome",
                                propertyName: "allowGoBack_label",
                            },
                            value: this.visualSettings.iconHome.allowGoBack_label
                            }
                    }
                },
                {
                    displayName: "Clicking Blank Space",
                    uid: "back_when_click_blank_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "iconHome",
                                propertyName: "allowGoBack_blank_space",
                            },
                            value: this.visualSettings.iconHome.allowGoBack_blank_space
                            }
                    }
                }
            ]
        }; 

        const goBack_general: powerbi.visuals.FormattingGroup = {
            displayName: "Icon",
            uid: "goBack_icon",
            slices: [
                {
                    displayName: "Size",
                    uid: "icon_size_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "iconHome",
                                propertyName: "size"
                            },
                            value: this.visualSettings.iconHome.size
                        }
                    }                        
                }              
            ]
        }; 

        const goBack_position: powerbi.visuals.FormattingGroup = {
            displayName: "Position",
            uid: "goBack_icon_position",
            slices: [
                {
                    displayName: "X",
                    uid: "xPosition_icon_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Slider,
                        properties: {
                            descriptor:
                            {
                                objectName: "iconHome",
                                propertyName: "x_position",
                            },
                            value: this.visualSettings.iconHome.x_position
                            }
                    }
                },
                {
                    displayName: "Y",
                    uid: "yPosition_icon_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Slider,
                        properties: {
                            descriptor:
                            {
                                objectName: "iconHome",
                                propertyName: "y_position"
                            },
                            value: this.visualSettings.iconHome.y_position
                        }
                    }                        
                }                  
            ]
        }; 

        const goBack_label: powerbi.visuals.FormattingGroup = {
            displayName: "Label",
            uid: "goBack_label",
            slices: [
                {
                    displayName: "Show Label",
                    uid: "icon_label_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "iconHome",
                                propertyName: "show_label",
                            },
                            value: this.visualSettings.iconHome.show_label
                            }
                    }
                },
                {                    
                    displayName: "Color",
                    uid: "iconHome_label_color",
                    disabled: this.visualSettings.iconHome.show_label ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "iconHome",
                                propertyName: "fontColor"
                            },
                            value: { value: this.visualSettings.iconHome.fontColor}
                        }
                    }
                },
                {
                    uid: "iconHome_label_control",
                    displayName: "Font",
                    disabled: this.visualSettings.iconHome.show_label ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.FontControl,
                        properties: {
                            fontFamily: {
                                descriptor: {
                                    objectName: "iconHome",
                                    propertyName: "fontFamily"
                                },
                                value: this.visualSettings.iconHome.fontFamily
                            },
                            fontSize: {
                                descriptor: {
                                    objectName: "iconHome",
                                    propertyName: "label_size"
                                },
                                value: this.visualSettings.iconHome.label_size
                            },
                            bold: {
                                descriptor: {
                                    objectName: "iconHome",
                                    propertyName: "textWeight"
                                },
                                value: this.visualSettings.iconHome.textWeight
                            },
                            italic: {
                                descriptor: {
                                    objectName: "iconHome",
                                    propertyName: "fontItalic"
                                },
                                value: this.visualSettings.iconHome.fontItalic
                            },
                            underline: {
                                descriptor: {
                                    objectName: "iconHome",
                                    propertyName: "fontUnderline"
                                },
                                value: this.visualSettings.iconHome.fontUnderline
                        }
                        }
                    }
                }     
            ]
        }; 


        goBack_arrow.groups.push(goBack_settings);
        goBack_arrow.groups.push(goBack_general);  
        goBack_arrow.groups.push(goBack_position);  
        goBack_arrow.groups.push(goBack_label);  





        // CARD TARGET VALUES
        const target_values: powerbi.visuals.FormattingCard = {
            description: "Target Value Settings",
            displayName: "Target Value",
            uid: "target_values_uid",
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "targetSettings",
                    propertyName: "showTarget",
                },
                {
                    objectName: "targetSettings",
                    propertyName: "targetType",
                },
                {
                    objectName: "targetSettings",
                    propertyName: "quarterUnits",
                },
                {
                    objectName: "targetSettings",
                    propertyName: "decimalPlaces",
                },
                {
                    objectName: "targetSettings",
                    propertyName: "fixedTarget"
                },
                {
                    objectName: "targetSettings",
                    propertyName: "targetLineColor"
                },
                {
                    objectName: "targetSettings",
                    propertyName: "targetLineOpacity"
                },
                {
                    objectName: "targetSettings",
                    propertyName: "targetLineWidth"
                },
                {
                    objectName: "targetSettings",
                    propertyName: "showLabel",
                },
                {
                    objectName: "targetSettings",
                    propertyName: "title",
                },
                {
                    objectName: "targetSettings",
                    propertyName: "fontColor"
                },
                {
                    objectName: "targetSettings",
                    propertyName: "fontFamily"
                },
                {
                    objectName: "targetSettings",
                    propertyName: "fontSize"                    
                },
                {
                    objectName: "targetSettings",
                    propertyName: "textWeight"
                },
                {
                    objectName: "targetSettings",
                    propertyName: "fontItalic"
                },
                {
                    objectName: "targetSettings",
                    propertyName: "fontUnderline"
                }
            ]
        }

        // GROUPS FOR CARD TARGET VALUES


        
        const group_target_values_general: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "target_values_general",
            slices: [
                {
                    displayName: "Show Target Reference",
                    uid: "show_reference_target_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "showTarget",
                            },
                            value: this.visualSettings.targetSettings.showTarget
                         }
                    }
                },
                {
                    displayName: "Target value",
                    uid: "target_value_slice",
                    disabled: !this.existTargetMetric && this.visualSettings.targetSettings.showTarget ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "fixedTarget"
                            },
                            value: this.visualSettings.targetSettings.fixedTarget
                        }
                    }
                },   
                {
                    displayName: "Visual Format",
                    uid: "visual_format_target_slice",
                    disabled: this.visualSettings.targetSettings.showTarget ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "targetType",
                            },
                            value: this.visualSettings.targetSettings.targetType
                         }
                    }
                },
                {
                    displayName: "Units",
                    uid: "display_units_target_slice",
                    disabled: this.visualSettings.targetSettings.showTarget ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "quarterUnits",
                            },
                            value: this.visualSettings.targetSettings.quarterUnits
                         }
                    }
                },  
                {
                    displayName: "Decimal Places",
                    uid: "decimal_places_target_slice",
                    disabled: this.visualSettings.targetSettings.showTarget ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "decimalPlaces",
                            },
                            value: this.visualSettings.targetSettings.decimalPlaces
                         }
                    }
                },             
            ]
        }; 


        const group_target_title_text: powerbi.visuals.FormattingGroup = {
            displayName: "Title",
            uid: "group_target_title_text",
            disabled: this.visualSettings.targetSettings.showTarget ? false : true,
            slices: [
                {
                    displayName: "Title",
                    uid: "label_target_title_slice",
                    disabled: this.visualSettings.targetSettings.showLabel && this.visualSettings.targetSettings.showTarget ? false : true, 
                    control: {
                        type: powerbi.visuals.FormattingComponent.TextInput,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetTitle",
                                propertyName: "title",
                            },
                            placeholder: "Write the title here",
                            value: this.visualSettings.targetTitle.title
                         }
                    }
                },
                {                    
                    displayName: "Color",
                    uid: "target_title_label_color",
                    disabled: this.visualSettings.targetSettings.showLabel && this.visualSettings.targetSettings.showTarget ? false : true, 
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetTitle",
                                propertyName: "fontColor"
                            },
                            value: { value: this.visualSettings.targetTitle.fontColor}
                        }
                    }
                },
                {
                    uid: "target_title_label_text_control",
                    displayName: "Font",
                    disabled: this.visualSettings.targetSettings.showLabel && this.visualSettings.targetSettings.showTarget ? false : true, 
                    control: {
                        type: powerbi.visuals.FormattingComponent.FontControl,
                        properties: {
                            fontFamily: {
                                descriptor: {
                                    objectName: "targetTitle",
                                    propertyName: "fontFamily"
                                },
                                value: this.visualSettings.targetTitle.fontFamily
                            },
                            fontSize: {
                                descriptor: {
                                    objectName: "targetTitle",
                                    propertyName: "fontSize"
                                },
                                value: this.visualSettings.targetTitle.fontSize
                            },
                            bold: {
                                descriptor: {
                                    objectName: "targetTitle",
                                    propertyName: "textWeight"
                                },
                                value: this.visualSettings.targetTitle.textWeight
                            },
                            italic: {
                                descriptor: {
                                    objectName: "targetTitle",
                                    propertyName: "fontItalic"
                                },
                                value: this.visualSettings.targetTitle.fontItalic
                            },
                            underline: {
                                descriptor: {
                                    objectName: "targetTitle",
                                    propertyName: "fontUnderline"
                                },
                                value: this.visualSettings.targetTitle.fontUnderline
                        }
                        }
                    }
                }     
            ]
        };



        const group_target_values_text: powerbi.visuals.FormattingGroup = {
            displayName: "Text",
            uid: "target_values_text",
            disabled: this.visualSettings.targetSettings.showTarget ? false : true,
            slices: [
                {
                    displayName: "Show Label",
                    uid: "show_label_target_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "showLabel",
                            },
                            value: this.visualSettings.targetSettings.showLabel
                         }
                    }
                },
                {                    
                    displayName: "Color",
                    uid: "target_label_color",
                    disabled: this.visualSettings.targetSettings.showLabel && this.visualSettings.targetSettings.showTarget ? false : true, 
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "fontColor"
                            },
                            value: { value: this.visualSettings.targetSettings.fontColor}
                        }
                    }
                },
                {
                    uid: "target_label_text_control",
                    displayName: "Font",
                    disabled: this.visualSettings.targetSettings.showLabel && this.visualSettings.targetSettings.showTarget ? false : true, 
                    control: {
                        type: powerbi.visuals.FormattingComponent.FontControl,
                        properties: {
                            fontFamily: {
                                descriptor: {
                                    objectName: "targetSettings",
                                    propertyName: "fontFamily"
                                },
                                value: this.visualSettings.targetSettings.fontFamily
                            },
                            fontSize: {
                                descriptor: {
                                    objectName: "targetSettings",
                                    propertyName: "fontSize"
                                },
                                value: this.visualSettings.targetSettings.fontSize
                            },
                            bold: {
                                descriptor: {
                                    objectName: "targetSettings",
                                    propertyName: "textWeight"
                                },
                                value: this.visualSettings.targetSettings.textWeight
                            },
                            italic: {
                                descriptor: {
                                    objectName: "targetSettings",
                                    propertyName: "fontItalic"
                                },
                                value: this.visualSettings.targetSettings.fontItalic
                            },
                            underline: {
                                descriptor: {
                                    objectName: "targetSettings",
                                    propertyName: "fontUnderline"
                                },
                                value: this.visualSettings.targetSettings.fontUnderline
                        }
                        }
                    }
                }     
            ]
        };





        const group_target_values_design: powerbi.visuals.FormattingGroup = {
            displayName: "Design",
            uid: "target_values_design",
            disabled: this.visualSettings.targetSettings.showTarget ? false : true,
            slices: [
                {                    
                    displayName: "Color",
                    uid: "target_color_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ColorPicker,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "targetLineColor"
                            },
                            value: { value: this.visualSettings.targetSettings.targetLineColor}
                        }
                    }
                },
                {
                    displayName: "Opacity",
                    uid: "line_opacity_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Slider,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "targetLineOpacity"
                            },
                            value: this.visualSettings.targetSettings.targetLineOpacity
                        }
                    }
                }, 
                {
                    displayName: "Width",
                    uid: "line_width_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "targetSettings",
                                propertyName: "targetLineWidth"
                            },
                            value: this.visualSettings.targetSettings.targetLineWidth
                        }
                    }
                },  
            ]
        }; 


        target_values.groups.push(group_target_values_general);  
        target_values.groups.push(group_target_values_design)
        target_values.groups.push(group_target_values_text);
        target_values.groups.push(group_target_title_text);

        

        // CARD ANIMATION
        const animation: powerbi.visuals.FormattingCard = {
            description: "Animation Settings",
            displayName: "Animation",
            uid: "animation_uid",
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "animationSettings",
                    propertyName: "enableAnimations",
                },
                {
                    objectName: "animationSettings",
                    propertyName: "duration"
                },
            ]
        }

        // GROUPS FOR CARD ANIMATION
        const group_animation_general: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "animation_general",
            slices: [
                {
                    displayName: "Enable Animations?",
                    uid: "enable_animations_slice",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "animationSettings",
                                propertyName: "enableAnimations",
                            },
                            value: this.visualSettings.animationSettings.enableAnimations
                         }
                    }
                },
                {
                    displayName: "Duration between transitions (in seconds)",
                    uid: "animation_duration_slicer",
                    disabled: this.visualSettings.animationSettings.enableAnimations ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor:
                            {
                                objectName: "animationSettings",
                                propertyName: "duration"
                            },
                            value: this.visualSettings.animationSettings.duration
                    }
                }
                }, 
            ]
        }; 

        animation.groups.push(group_animation_general);  
        



        // CARD TOOLTIP
        const tooltip: powerbi.visuals.FormattingCard = {
            description: "Tooltip Settings",
            displayName: "Tooltip",
            uid: "tooltip_uid",
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "tooltipSettings",
                    propertyName: "removeMeasure"
                },
                {
                    objectName: "tooltipSettings",
                    propertyName: "removeCategory"
                },
                {
                    objectName: "tooltipSettings",
                    propertyName: "titleMeasure"
                },
                {
                    objectName: "tooltipSettings",
                    propertyName: "tooltipUnits"
                },
                {
                    objectName: "tooltipSettings",
                    propertyName: "decimalPlaces"
                },
                {
                    objectName: "tooltipSettings",
                    propertyName: "showDescription"
                },
                {
                    objectName: "tooltipSettings",
                    propertyName: "description"
                },
                {
                    objectName: "tooltipSettings",
                    propertyName: "titleDescription"
                },
                {
                    objectName: "tooltipSettings",
                    propertyName: "showExtraValue"
                },
            ]
        }

        // GROUPS FOR CARD TOOLTIP
        const group_tooltip_general: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "tooltip_general",
            slices: [
                {
                    displayName: "Hide Group Total Value",
                    uid: "tooltip_hide_total_value",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "tooltipSettings",
                                propertyName: "removeMeasure"
                            },
                            value: this.visualSettings.tooltipSettings.removeMeasure
                        }
                    }
                },
                {
                    displayName: "Hide Category Sub-Total Value",
                    uid: "tooltip_hide_category_value",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "tooltipSettings",
                                propertyName: "removeCategory"
                            },
                            value: this.visualSettings.tooltipSettings.removeCategory
                        }
                    }
                }
            ]
        }; 


        const group_tooltip_value: powerbi.visuals.FormattingGroup = {
            displayName: "Value",
            uid: "tooltip_value",
            disabled: this.visualSettings.tooltipSettings.removeMeasure ? true : false,
            slices: [
                {       
                    displayName: "Title",           
                    uid: "title_tooltip",
                    control: {
                        type: powerbi.visuals.FormattingComponent.TextInput,
                        properties: {
                            descriptor:
                            {
                                objectName: "tooltipSettings",
                                propertyName: "titleMeasure"
                            },
                            placeholder: "Write the title", 
                            value: this.visualSettings.tooltipSettings.titleMeasure
                        }
                    }
                },
                {                    
                    displayName: "Display Units (Reference number: 1500)",
                    uid: "tooltipUnits",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "tooltipSettings",
                                propertyName: "tooltipUnits"
                            },
                            value: this.visualSettings.tooltipSettings.tooltipUnits
                        }
                    }
                },
                {
                    displayName: "Decimal Places",
                    uid: "tooltip_decimal_places",
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor: {
                                objectName: "tooltipSettings",
                                propertyName: "decimalPlaces"
                            },
                            value: this.visualSettings.tooltipSettings.decimalPlaces
                        }
                    }
                },
                {
                    displayName: "Show Extra Value",
                    uid: "tooltip_show_extra_value",
                    disabled: this.extraTooltip != null ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "tooltipSettings",
                                propertyName: "showExtraValue"
                            },
                            value: this.visualSettings.tooltipSettings.showExtraValue
                        }
                    }
                }
            ]
        }



        const group_tooltip_description: powerbi.visuals.FormattingGroup = {
            displayName: "Description",
            uid: "tooltip_description",
            slices: [
                {
                    displayName: "Show Description",
                    uid: "tooltip_show_description",
                    control: {
                        type: powerbi.visuals.FormattingComponent.ToggleSwitch,
                        properties: {
                            descriptor:
                            {
                                objectName: "tooltipSettings",
                                propertyName: "showDescription"
                            },
                            value: this.visualSettings.tooltipSettings.showDescription
                        }
                    }
                },
                {       
                    displayName: "Description",           
                    uid: "description_tooltip",
                    disabled: this.visualSettings.tooltipSettings.showDescription ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.TextInput,
                        properties: {
                            descriptor:
                            {
                                objectName: "tooltipSettings",
                                propertyName: "description"
                            },
                            placeholder: "Write the description", 
                            value: this.visualSettings.tooltipSettings.description
                        }
                    }
                },
                {       
                    displayName: "Title",           
                    uid: "description_title_tooltip",
                    disabled: this.visualSettings.tooltipSettings.showDescription ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.TextInput,
                        properties: {
                            descriptor:
                            {
                                objectName: "tooltipSettings",
                                propertyName: "titleDescription"
                            },
                            placeholder: "Write the title for the description", 
                            value: this.visualSettings.tooltipSettings.titleDescription
                        }
                    }
                },
            ]
        }


        tooltip.groups.push(group_tooltip_general);  
        tooltip.groups.push(group_tooltip_value);  
        tooltip.groups.push(group_tooltip_description);  



        


        // Initialize secondMeasure outside of the if block
        const secondMeasure: powerbi.visuals.FormattingCard = {
            description: "Second Measure Settings",
            displayName: "Second Measure",
            uid: "secondMeasure_uid",
            disabled: this.showSecondMeasureSettings ? false : true,
            groups: [],
            revertToDefaultDescriptors: [
                {
                    objectName: "secondMeasureSettings",
                    propertyName: "showValue"
                },
                {
                    objectName: "secondMeasureSettings",
                    propertyName: "quarterUnits"
                },
                {
                    objectName: "secondMeasureSettings",
                    propertyName: "quarterUnits"
                },
                {
                    objectName: "secondMeasureSettings",
                    propertyName: "labelUnits"
                },
                {
                    objectName: "secondMeasureSettings",
                    propertyName: "tooltipUnits"
                },
                {
                    objectName: "secondMeasureSettings",
                    propertyName: "decimalPlaces"
                },
            ]
        }

        // GROUPS SECOND MEASURE
        const group_secondMeasure_general: powerbi.visuals.FormattingGroup = {
            displayName: "Options",
            uid: "secondMeasure_general",
            disabled: this.showSecondMeasureSettings ? false : true,
            slices: [
                {
                    displayName: "What value should appear on drill down?",
                    uid: "show_value_secondMeasure",
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "secondMeasureSettings",
                                propertyName: "showValue"
                            },
                            value: this.visualSettings.secondMeasureSettings.showValue
                        }
                    }
                },
                {
                    displayName: "Quarter Display Units",
                    uid: "secondMeasure_quarter_display_units",
                    disabled: this.existsSecondMeasure ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "secondMeasureSettings",
                                propertyName: "quarterUnits"
                            },
                            value: this.visualSettings.secondMeasureSettings.quarterUnits
                        }
                    }
                },
                {
                    displayName: "Label Display Units",
                    uid: "secondMeasure_label_display_units",
                    disabled: this.existsSecondMeasure ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "secondMeasureSettings",
                                propertyName: "labelUnits"
                            },
                            value: this.visualSettings.secondMeasureSettings.labelUnits
                        }
                    }
                },
                {
                    displayName: "Tooltip Display Units",
                    uid: "secondMeasure_label_display_units",
                    disabled: this.existsSecondMeasure ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.Dropdown,
                        properties: {
                            descriptor:
                            {
                                objectName: "secondMeasureSettings",
                                propertyName: "tooltipUnits"
                            },
                            value: this.visualSettings.secondMeasureSettings.tooltipUnits
                        }
                    }
                },
                {
                    displayName: "Value Decimal Places",
                    uid: "secondMeasure_value_decimal_places",
                    disabled: this.existsSecondMeasure ? false : true,
                    control: {
                        type: powerbi.visuals.FormattingComponent.NumUpDown,
                        properties: {
                            descriptor: {
                                objectName: "secondMeasureSettings",
                                propertyName: "decimalPlaces"
                            },
                            value: this.visualSettings.secondMeasureSettings.decimalPlaces
                        }
                    }
                }
            ]
        };

        secondMeasure.groups.push(group_secondMeasure_general);




        // Initialize formattingModel with an empty array or with secondMeasure if it's defined
        const formattingModel: powerbi.visuals.FormattingModel = {
            cards: [max_value, label, labelValue, labelSeparator, number_labels, radial_bar, outside_circle, quarter_reference, target_values, goBack_arrow, animation, tooltip]
        };


        if (secondMeasure) {
            formattingModel.cards.push(secondMeasure);
        }


        return formattingModel;
    } 



    /**
     * Function Name: measureWordHeight
     * Description: Measures the height of a word based on font size and font family.
     *
     * @param {string} word - The word to measure.
     * @param {string} fontSize - The font size in pixels.
     * @param {string} fontFamily - The font family for the word.
     * @returns {number} - The height of the word in pixels.
     */
    private measureWordHeight(word: string, fontSize: number, fontFamily: string) {

        const textProperties: TextProperties = {
            text: word,
            fontFamily: fontFamily,
            fontSize: fontSize + "pt"
        };

        const label_size = this.measureSvgTextHeight(textProperties)

        return label_size
    }



    /**
     * Function Name: measureSvgTextHeight
     * Description: Measures the height of SVG text based on text properties.
     *
     * @param {object} textProperties - An object containing text properties such as font size, font family, etc.
     * @returns {number} - The height of the SVG text in pixels.
     */
    private measureSvgTextHeight(textProperties) {
        this.ensureDOM();
        this.canvasCty.font =
            (textProperties.fontStyle || "") + " " +
            (textProperties.fontVariant || "") + " " +
            (textProperties.fontWeight || "") + " " +
            textProperties.fontSize + " " +
            (textProperties.fontFamily || this.fallbackFontFamily);

        return (this.canvasCty.measureText(textProperties.text).actualBoundingBoxAscent + this.canvasCty.measureText(textProperties.text).actualBoundingBoxDescent) * 1.15
    }



    /**
     * Function Name: ensureDOM
     * Description: Ensures the presence of necessary DOM elements for measuring text properties.
     */
    private ensureDOM() {
        if (this.spanElement) {
            return;
        }
        this.spanElement = document.createElement("span");
        document.body.appendChild(this.spanElement);
        // The style hides the svg element from the canvas, preventing canvas from scrolling down to show svg black square.
        const svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svgElement.setAttribute("height", "0");
        svgElement.setAttribute("width", "0");
        svgElement.setAttribute("position", "absolute");
        svgElement.style.top = "0px";
        svgElement.style.left = "0px";
        svgElement.style.position = "absolute";
        svgElement.style.height = "0px";
        svgElement.style.width = "0px";
        this.svgTextElement = document.createElementNS("http://www.w3.org/2000/svg", "text");
        svgElement.appendChild(this.svgTextElement);
        document.body.appendChild(svgElement);
        const canvasElement = document.createElement("canvas");
        this.canvasCty = canvasElement.getContext("2d");
        const style = window.getComputedStyle(this.svgTextElement);
        if (style) {
            this.fallbackFontFamily = style.fontFamily;
        }
        else {
            this.fallbackFontFamily = "";
        }
    }


    /**
     * Function Name: measureWordWidth
     * Description: Measures the width of a word based on font size and font family.
     *
     * @param {string} word - The word to measure.
     * @param {string} fontSize - The font size in pixels.
     * @param {string} fontFamily - The font family for the word.
     * @returns {number} - The width of the word in pixels.
     */
    private measureWordWidth(word: string, fontSize: number, fontFamily: string, isBold: boolean, isItalic: boolean): number {
        // Check for the actual text styling (bold, italic, underline)
        const fontWeight = isBold ? "bold" : "normal";
        const fontStyle = isItalic ? "italic" : "normal";
    
        // Create text properties including font style, weight, and decoration
        const textProperties: TextProperties = {
            text: word,
            fontFamily: fontFamily,
            fontSize: fontSize + "pt",
            fontWeight: fontWeight,
            fontStyle: fontStyle
        };
    
        // Measure the text width with the appropriate style
        const label_size = textMeasurementService.measureSvgTextWidth(textProperties);
    
        return label_size;
    }
    

    /**
     * Function Name: measureBiggestWordSpacing
     * Description: Measures the width of the longest word in an array based on font size and font family.
     *
     * @param {string[]} array - An array of words to find the longest word from.
     * @param {string} fontSize - The font size in pixels.
     * @param {string} fontFamily - The font family for the words.
     * @returns {number} - The width of the longest word in pixels.
     */
    private measureBiggestWordSpacing(array, fontSize: number, fontFamily: string) {
        const longest = array.reduce(function (a, b) { return a.length > b.length ? a : b; });

        const textProperties: TextProperties = {
            text: longest,
            fontFamily: fontFamily,
            fontSize: fontSize + "pt"
        };

        const label_size = textMeasurementService.measureSvgTextWidth(textProperties)

        return label_size
    }

    private onlyUnique(value, index, self) {
        return self.indexOf(value) === index;
    }


    /**
     * Function Name: getTooltipData
     * Description: Constructs tooltip data based on the provided object data and context, considering various tooltip settings.
     *
     * @param {TooltipEventArgs<DataPoint>} objectData - The object data containing information for the tooltip.
     * @param {any} context - The context or reference for constructing the tooltip data.
     * @returns {VisualTooltipDataItem[]} - An array of tooltip data items for display.
     */
    private getTooltipData(objectData : TooltipEventArgs<DataPoint>): VisualTooltipDataItem[] {

        const identifier = objectData["category"]
        let tooltip = null

        if (this.categorySelected) {
            tooltip = this.viewModel.dataPoints.filter(d => d.category == identifier)[0].tooltips
        } else {
            
            tooltip = [{
                displayName: this.visualSettings.tooltipSettings.showDescription ? "" : "Group",
                value: <string>identifier
            }]
            
            if (!this.visualSettings.tooltipSettings.removeMeasure) {
                const totalValue = this.viewModel.dataPoints.filter(d => d.os == identifier).map(d => d.value).reduce((a, b) => a + b, 0)
                tooltip.push({
                    displayName: this.visualSettings.tooltipSettings.titleMeasure == "" ? this.valueColumnName : this.visualSettings.tooltipSettings.titleMeasure,
                    value: this.formatValue(totalValue, this.defaultCubeFormat, this.visualSettings.tooltipSettings.decimalPlaces, this.visualSettings.tooltipSettings.tooltipUnits)
                })                
            }

            if (!this.visualSettings.tooltipSettings.removeCategory) {
                tooltip.push({
                    displayName: objectData["group"],
                    value: this.formatValue(objectData["value"], this.defaultCubeFormat, this.visualSettings.tooltipSettings.decimalPlaces, this.visualSettings.tooltipSettings.tooltipUnits)
                })
            }
            
            if ((this.extraTooltip != null) && this.visualSettings.tooltipSettings.showExtraValue && this.visualSettings.tooltipSettings.showDescription) {
                const totalValue = this.viewModel.dataPoints.filter(d => d.os == identifier).map(d => d.extraValue).reduce((a, b) => a + b, 0)
                tooltip.push({
                    displayName: this.extraTooltip.source.displayName + " Total",
                    value: this.formatValue(totalValue, this.defaultCubeFormat, this.visualSettings.tooltipSettings.decimalPlaces, this.visualSettings.tooltipSettings.tooltipUnits)       
                })
                tooltip.push({
                    displayName: this.visualSettings.tooltipSettings.titleDescription,
                    value: this.visualSettings.tooltipSettings.description
                })
            } else if ((this.extraTooltip != null) && this.visualSettings.tooltipSettings.showExtraValue && !this.visualSettings.tooltipSettings.showDescription) {
                const totalValue = this.viewModel.dataPoints.filter(d => d.os == identifier).map(d => d.extraValue).reduce((a, b) => a + b, 0)
                tooltip.push({
                    displayName: this.extraTooltip.source.displayName + " Total",
                    value: this.formatValue(totalValue, this.defaultCubeFormat, this.visualSettings.tooltipSettings.decimalPlaces, this.visualSettings.tooltipSettings.tooltipUnits)
                })
            } else if (this.visualSettings.tooltipSettings.showDescription) {
                tooltip.push({
                    displayName: this.visualSettings.tooltipSettings.titleDescription,
                    value: this.visualSettings.tooltipSettings.description
                })
            }
            
        }

        return tooltip
    }

    /**
     * Function Name: getTooltipIdentity
     * Description: Retrieves the selection identity from the provided value.
     *
     * @param {any} value - The value containing the selection identity.
     * @returns {powerbi.visuals.ISelectionId} - The selection identity.
     */
    private getTooltipIdentity(value: TooltipEventArgs<DataPoint>): powerbi.visuals.ISelectionId {

        return value["identity"]
    }



    /**
     * Function Name: dynamicFormat
     * Description: Dynamically formats a numeric value based on the specified format and default decimal places.
     *
     * @param {number} labelValue - The numeric value to be formatted.
     * @param {string} format - The format for the numeric value ("cube-billions", "cube-millions", "cube-thousands", or "default").
     * @param {number} defaultDecimalPlaces - The default number of decimal places to use in formatting.
     * @returns {string} - The dynamically formatted numeric value as a string.
     */
    private dynamicFormat(labelValue: number, format: string, setDecimalPlaces: number, roundValuesUp: boolean): string {
        let decimal = "1";
        let decimalSmallValues = "0.";
    
        for (let i = 1; i <= setDecimalPlaces; i++) {
            decimal += "0";
            decimalSmallValues += "0";
        }
    
        if (format === undefined || (format === "0" && labelValue === 0)) {
            return labelValue.toString();
        }
    
        if (format.includes("0.") && !format.includes("%") && !format.includes("$") && format !== "undefined") {
            const decimalPlaces = "0." + "0".repeat(setDecimalPlaces);
            return this.iValueFormatter.valueFormatter.create({ format: decimalPlaces || "0.0" }).format(labelValue);
        } else if (!format.includes("%") && format !== "undefined") {
            let value = "0";
            const sign = labelValue < 0 ? "-" : "";
            const absValue = Math.abs(labelValue);
            const decimalNum = parseFloat(decimal);
    
            if (absValue >= 1.0e+12) {
                value = sign + (format.includes("$") ? "$" : "") + (Math.round((absValue / 1.0e+12) * decimalNum) / decimalNum).toFixed(setDecimalPlaces) + "T";
            } else if (absValue >= 1.0e+9) {
                const over100 = Math.round(absValue / 1.0e+9) > 100;
                value = sign + (format.includes("$") ? "$" : "") + (Math.round((absValue / (over100 && roundValuesUp ? 1.0e+12 : 1.0e+9)) * decimalNum) / decimalNum).toFixed(setDecimalPlaces) + (over100 && roundValuesUp ? "T" : "B");
            } else if (absValue >= 1.0e+6) {
                const over100 = Math.round(absValue / 1.0e+6) > 100;
                value = sign + (format.includes("$") ? "$" : "") + (Math.round((absValue / (over100 && roundValuesUp ? 1.0e+9 : 1.0e+6)) * decimalNum) / decimalNum).toFixed(setDecimalPlaces) + (over100 && roundValuesUp ? "B" : "M");
            } else if (absValue >= 1.0e+3) {
                const over100 = Math.round(absValue / 1.0e+3) > 100;
                value = sign + (format.includes("$") ? "$" : "") + (Math.round((absValue / (over100 && roundValuesUp ? 1.0e+6 : 1.0e+3)) * decimalNum) / decimalNum).toFixed(setDecimalPlaces) + (over100 && roundValuesUp ? "M" : "K");
            } else if (absValue < (1 / decimalNum)) {
                value = sign + (format.includes("$") ? "$" : "") + (labelValue === 0 ? "0" : decimalSmallValues);
            } else {
                value = sign + (format.includes("$") ? "$" : "") + (Math.round(absValue * decimalNum) / decimalNum).toFixed(0);
            }
    
            return value;
        } else if (format.includes("%") && format !== "undefined") {
            return (labelValue < 0 ? "-" : "") + this.iValueFormatter.valueFormatter.create({ format: format || "0.0%;-0.0%;0.0%" }).format((Math.abs(labelValue) * 100).toFixed(setDecimalPlaces)) + "%";
        } else if (format === "undefined") {
            return labelValue.toString();
        }
    }

    public formatThousands(value, decimalCases) {
        return `$${(value / 1e3).toLocaleString(undefined, { minimumFractionDigits: decimalCases, maximumFractionDigits: decimalCases })}k`;
    }
    
    public formatMillions(value, decimalCases) {
        return `$${(value / 1e6).toLocaleString(undefined, { minimumFractionDigits: decimalCases, maximumFractionDigits: decimalCases })}M`;
    }
    
    public formatBillions(value, decimalCases) {
        return `$${(value / 1e9).toLocaleString(undefined, { minimumFractionDigits: decimalCases, maximumFractionDigits: decimalCases })}B`;
    }
    
    private formatValue(labelValue, format: string, decimalPlaces: number, displayUnits: string) {
        
        let formattedValue = displayUnits == "dynamic" ?
            this.dynamicFormat(labelValue, format, decimalPlaces, true) :
            displayUnits == "default" ?
                this.iValueFormatter.valueFormatter.create({ format: format || "#,0" }).format(labelValue) :
            displayUnits === "cube-thousands" ?
                this.formatThousands(labelValue, decimalPlaces) :
            displayUnits === "cube-millions" ?
                this.formatMillions(labelValue, decimalPlaces) :
            displayUnits === "cube-billions" ?
                this.formatBillions(labelValue, decimalPlaces) :
                d3.format(displayUnits)(labelValue);
    
        if (formattedValue.startsWith("-")) {
            formattedValue = `(${formattedValue.substring(1)})`;
        }
    
        return formattedValue;
    }



    /**
     * Function Name: getViewModel
     * Description: Constructs the ViewModel for the visualization based on the provided dataViews and options.
     *
     * @param {VisualUpdateOptions} options - The update options containing dataViews.
     * @returns {ViewModel} - The ViewModel containing data points, metadata, and calculated values for the visualization.
     */
    private getViewModel(options: VisualUpdateOptions): ViewModel {
        const dv = options.dataViews;

        const format = valueFormatter.valueFormatter;

        const viewModel: ViewModel = {
            dataPoints: [],
            maxValue: 0,
            average: 0,
            total: 0
        };

        if (!dv
            || !dv[0]
            || !dv[0].categorical
            || !dv[0].categorical.categories
            || !dv[0].categorical.categories[0].source
            || !dv[0].categorical.values
            || !dv[0].metadata)
            return viewModel;

        this.sortByValues = dv[0].metadata.columns.filter(d => d.sort)[0].isMeasure
        this.sortOrder = dv[0].metadata.columns.filter(d => d.sort)[0].sort

        const view = dv[0].categorical;

        const columns = dv[0].categorical.categories.length

        let categories;
        let oss;

        if (columns == 2) {
            categories = dv[0].categorical.categories.filter(d => d.source.roles["xaxis"])[0]
            oss = dv[0].categorical.categories.filter(d => d.source.roles["yaxis"])[0]
        }
        else if (columns == 1) {
            oss = view.categories[0];
            categories = view.categories[0];
        }

        const values = view.values[0];
        this.extraTooltip = view.values.filter(d => d.source.roles.extraTooltip).length > 0 ? view.values.filter(d => d.source.roles.extraTooltip)[0] : null

        this.existsSecondMeasure = view.values.filter(d => d.source.roles.secondmeasure).length > 0 && this.visualSettings.secondMeasureSettings.showValue == "second" ? true : false
        this.showSecondMeasureSettings = view.values.filter(d => d.source.roles.secondmeasure).length > 0 ? true : false
        this.existTargetMetric = view.values.filter(d => d.source.roles.target).length > 0 ? true : false
        this.targetValue = this.existTargetMetric ? <number>view.values.filter(d => d.source.roles.target)[0].values[0] : 0
        const objects = categories.objects;

        const metadata = dv[0].metadata;

        this.valueColumnName = metadata.columns.filter(d => d.roles["firstmeasure"])[0].displayName;

        const container = oss.values.map(d => d).filter(this.onlyUnique)
        let selected_color_scheme = "hexaColor"
        let davaViewOption = dataViewObjects.dataViewObjects.getFillColor
        let colors_range = []
        if (this.visualSettings.radialSettings.colorScheme == "color") {
            colors_range = ["blue", "green", "purple", "red", "grey", "orange"]
            selected_color_scheme = "color"
            davaViewOption = dataViewObjects.dataViewObjects.getValue
        } else if (this.visualSettings.radialSettings.colorScheme == "hexaColor") {
            colors_range = ["#C499CA", "#A0D1FF", "#E044A7", "#9B59B6", "#2980B9", "#C493EA", "#1ABC9C", "#16A085", "#F1C49F", "#F39C12", "#D35400", "#BDC3C7", "#7F8C8D", "#2C3E50", "#3F4CB0", "#E1EC4C"]
            selected_color_scheme = "hexaColor"
            davaViewOption = dataViewObjects.dataViewObjects.getFillColor
        } else if (this.visualSettings.radialSettings.colorScheme == "color_alternative") {
            colors_range = ["bugn", "bupu", "gnbu", "orrd", "pubugn", "pubu", "purd", "rdpu", "ylgnbu", "ylgn", "ylorbr", "ylorrd"]
            selected_color_scheme = "color_alternative"
            davaViewOption = dataViewObjects.dataViewObjects.getValue
        }


        const unique_categories = oss.values.filter(this.onlyUnique)
        this.cubeFormatIsPercentage = view.values.filter(d => d.source.isMeasure)[0].source.format && view.values.filter(d => d.source.isMeasure)[0].source.format.includes("0%") ? true : false;
        this.cubeFormat = format.create({ format: this.existsSecondMeasure && this.categorySelected ? view.values.filter(d => d.source.isMeasure)[1].source.format : view.values.filter(d => d.source.isMeasure)[0].source.format || "#,0" })
        this.defaultCubeFormat = this.existsSecondMeasure && this.categorySelected && view.values.filter(d => d.source.isMeasure)[1].source.format ? view.values.filter(d => d.source.isMeasure)[1].source.format : view.values.filter(d => d.source.isMeasure)[0].source.format

        if (this.defaultCubeFormat == undefined) {
            this.defaultCubeFormat = "$#,0;($#,0);$#,0"; // Corrected version
        }
        


        for (let i = 0, len = Math.max(categories.values.length, values.values.length); i < len; i++) {

            if (oss.values[i] == this.selectedCategoryName || !this.categorySelected) {
                let tooltip = [{displayName: "",
                    value: ""
                }]
                if (this.existsSecondMeasure && this.categorySelected) {
                    tooltip = [{
                        displayName: "Category",
                        value: <string>categories.values[i]
                    }, {
                        displayName: view.values.filter(d => d.source.isMeasure)[1].source.displayName,
                        value: this.formatValue(<number>view.values.filter(d => d.source.isMeasure)[1].values[i], view.values.filter(d => d.source.isMeasure)[1].source.format, this.visualSettings.secondMeasureSettings.decimalPlaces, this.visualSettings.secondMeasureSettings.tooltipUnits) 
                    }]
                } else {
                    tooltip = [{
                        displayName: "Category",
                        value: <string>categories.values[i]
                    }, {
                        displayName: this.valueColumnName,
                        value: this.formatValue(<number>values.values[i], this.defaultCubeFormat, this.visualSettings.tooltipSettings.decimalPlaces, this.visualSettings.tooltipSettings.tooltipUnits) 
                    }]
                }


                viewModel.dataPoints.push({
                    os: !this.categorySelected ? <string>oss.values[i] : <string>categories.values[i],
                    category: <string>categories.values[i],
                    value: <number>values.values[i],
                    valueSecondMeasure: this.existsSecondMeasure ? this.categorySelected ? <number>view.values.filter(d => d.source.isMeasure)[1].values[i] : <number>view.values.filter(d => d.source.isMeasure)[0].values[i] : 0,
                    target: this.existTargetMetric ? <number>view.values.filter(d => d.source.roles.target)[0].values[i] : 0,
                    extraValue: this.extraTooltip != null ? <number>this.extraTooltip.values[i] : 0,
                    accu: <number>values.values[i],
                    color: objects && <string>davaViewOption(objects[i],
                        { objectName: "radialSettings", propertyName: selected_color_scheme },
                        colors_range[unique_categories.indexOf(oss.values[i])]) || colors_range[unique_categories.indexOf(oss.values[i])],
                    identity: this.host.createSelectionIdBuilder()
                        .withCategory(view.categories[0], i)
                        .createSelectionId(),
                    tooltips: tooltip
                    
                })
            }
        }

        if (viewModel.dataPoints.length > 0) {
            viewModel.average = d3.sum(viewModel.dataPoints, d => d.value) / viewModel.dataPoints.length
            viewModel.total = d3.sum(viewModel.dataPoints.filter(d => d.category != null), d => d.value)
        }

        viewModel.maxValue = d3.max(viewModel.dataPoints, d => d.value);

        const accumulative = []

        for (let kk = 0; kk < container.length; kk++) {
            let mount = 0
            for (let pp = 0; pp < viewModel.dataPoints.length; pp++) {
                if (viewModel.dataPoints[pp].os == container[kk]) {
                    mount = mount + viewModel.dataPoints[pp].value
                    viewModel.dataPoints[pp].accu = mount
                }
            }
            accumulative.push(mount)
        }

        return viewModel;
    }
}